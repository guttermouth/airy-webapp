'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

/**
 * Basic XHR Library with some notions hardcoded in
 * of what the Layer server expects/returns.
 *
    layer.xhr({
      url: 'http://my.com/mydata',
      data: {hey: 'ho', there: 'folk'},
      method: 'GET',
      format: 'json',
      headers: {'fred': 'Joe'},
      timeout: 50000
    }, function(result) {
      if (!result.success) {
        errorHandler(result.data, result.headers, result.status);
      } else {
        successHandler(result.data, result.headers, result.xhr);
      }
    });
 *
 * @class layer.xhr
 * @private
 */

/**
 * Send a Request.
 *
 * @method  xhr
 * @param {Object} options
 * @param {string} options.url
 * @param {Mixed} [options.data=null]
 * @param {string} [options.format=''] - set to 'json' to get result parsed as json (in case there is no obvious Content-Type in the response)
 * @param {Object} [options.headers={}] - Name value pairs for  headers and their values
 * @param {number} [options.timeout=0] - When does the request expire/timeout in miliseconds.
 * @param {Function} callback
 * @param {Object} callback.result
 * @param {number} callback.result.status - http status code
 * @param {boolean} callback.result.success - true if it was a successful response
 * @param {XMLHttpRequest} callback.result.xhr - The XHR object used for the request
 * @param {Object} callback.result.data -  The parsed response body
 *
 * TODO:
 *
 * 1. Make this a subclass of Root and make it a singleton so it can inherit a proper event system
 * 2. Result should be a layer.ServerResponse instance
 * 3. Should only access link headers if requested; annoying having it throw errors every other time.
 */

// Don't set xhr to window.XMLHttpRequest as it will bypass jasmine's
// ajax library
var Xhr = typeof window === 'undefined' ? require('xhr2') : null;

function parseLinkHeaders(linkHeader) {
  if (!linkHeader) return {};

  // Split parts by comma
  var parts = linkHeader.split(',');
  var links = {};

  // Parse each part into a named link
  parts.forEach(function (part) {
    var section = part.split(';');
    if (section.length !== 2) return;
    var url = section[0].replace(/<(.*)>/, '$1').trim();
    var name = section[1].replace(/rel='?(.*)'?/, '$1').trim();
    links[name] = url;
  });

  return links;
}

module.exports = function (request, callback) {
  var startTime = Date.now();
  var req = Xhr ? new Xhr() : new XMLHttpRequest();
  var method = (request.method || 'GET').toUpperCase();

  var onload = function onload() {
    var headers = {
      'content-type': this.getResponseHeader('content-type')
    };

    var result = {
      status: this.status,
      success: this.status && this.status < 300,
      xhr: this
    };

    var isJSON = String(headers['content-type']).split(/;/)[0].match(/^application\/json/) || request.format === 'json';

    if (this.responseType === 'blob' || this.responseType === 'arraybuffer') {
      if (this.status === 0) {
        result.data = new Error('Connection Failed');
      } else {
        // Damnit, this.response is a function if using jasmine test framework.
        result.data = typeof this.response === 'function' ? this.responseText : this.response;
      }
    } else {
      if (isJSON && this.responseText) {
        try {
          result.data = JSON.parse(this.responseText);
        } catch (err) {
          result.data = {
            code: 999,
            message: 'Invalid JSON from server',
            response: this.responseText
          };
          result.status = 999;
        }
      } else {
        result.data = this.responseText;
      }

      // Note that it is a successful connection if we get back an error from the server,
      // it may have been a failed request, but the connection was good.
      module.exports.trigger({
        target: this,
        status: !this.responseText && !this.status ? 'connection:error' : 'connection:success',
        duration: Date.now() - startTime,
        request: request
      });

      if (!this.responseText && !this.status) {
        result.status = 408;
        result.data = {
          id: 'request_timeout',
          message: 'The server is not responding please try again in a few minutes',
          url: 'https://docs.layer.com/reference/client_api/errors',
          code: 0,
          status: 408,
          httpStatus: 408
        };
      } else if (this.status === 404 && _typeof(result.data) !== 'object') {
        result.data = {
          id: 'operation_not_found',
          message: 'Endpoint ' + (request.method || 'GET') + ' ' + request.url + ' does not exist',
          status: this.status,
          httpStatus: 404,
          code: 106,
          url: 'https://docs.layer.com/reference/client_api/errors'
        };
      } else if (typeof result.data === 'string' && this.status >= 400) {
        result.data = {
          id: 'unknown_error',
          message: result.data,
          status: this.status,
          httpStatus: this.status,
          code: 0,
          url: 'https://www.google.com/search?q=doh!'
        };
      }
    }

    if (request.headers && (request.headers.accept || '').match(/application\/vnd.layer\+json/)) {
      var links = this.getResponseHeader('link');
      if (links) result.Links = parseLinkHeaders(links);
    }
    result.xhr = this;

    if (callback) callback(result);
  };

  req.onload = onload;

  // UNTESTED!!!
  req.onerror = req.ontimeout = onload;

  // Replace all headers in arbitrary case with all lower case
  // for easy matching.
  var headersList = Object.keys(request.headers || {});
  var headers = {};
  headersList.forEach(function (header) {
    if (header.toLowerCase() === 'content-type') {
      headers['content-type'] = request.headers[header];
    } else {
      headers[header.toLowerCase()] = request.headers[header];
    }
  });
  request.headers = headers;

  var data = '';
  if (request.data) {
    if (typeof Blob !== 'undefined' && request.data instanceof Blob) {
      data = request.data;
    } else if (request.headers && (String(request.headers['content-type']).match(/^application\/json/) || String(request.headers['content-type']) === 'application/vnd.layer-patch+json')) {
      data = typeof request.data === 'string' ? request.data : JSON.stringify(request.data);
    } else if (request.data && _typeof(request.data) === 'object') {
      Object.keys(request.data).forEach(function (name) {
        if (data) data += '&';
        data += name + '=' + request.data[name];
      });
    } else {
      data = request.data; // Some form of raw string/data
    }
  }
  if (data) {
    if (method === 'GET') {
      request.url += '?' + data;
    }
  }

  req.open(method, request.url, true);
  if (request.timeout) req.timeout = request.timeout;
  if (request.withCredentials) req.withCredentials = true;
  if (request.responseType) req.responseType = request.responseType;

  if (request.headers) {
    Object.keys(request.headers).forEach(function (headerName) {
      return req.setRequestHeader(headerName, request.headers[headerName]);
    });
  }

  try {
    if (method === 'GET') {
      req.send();
    } else {
      req.send(data);
    }
  } catch (e) {
    // do nothing
  }
};

var listeners = [];
module.exports.addConnectionListener = function (func) {
  return listeners.push(func);
};

module.exports.trigger = function (evt) {
  listeners.forEach(function (func) {
    return func(evt);
  });
};
//# sourceMappingURL=data:application/json;base64,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Q0QsS0FGRCxNQUVPO0FBQ0wsVUFBSSxJQUFKLENBQVMsSUFBVDtBQUNEO0FBQ0YsR0FORCxDQU1FLE9BQU8sQ0FBUCxFQUFVO0FBQ1Y7QUFDRDtBQUNGLENBdkpEOztBQXlKQSxJQUFNLFlBQVksRUFBbEI7QUFDQSxPQUFPLE9BQVAsQ0FBZSxxQkFBZixHQUF1QztBQUFBLFNBQVEsVUFBVSxJQUFWLENBQWUsSUFBZixDQUFSO0FBQUEsQ0FBdkM7O0FBRUEsT0FBTyxPQUFQLENBQWUsT0FBZixHQUF5QixVQUFDLEdBQUQsRUFBUztBQUNoQyxZQUFVLE9BQVYsQ0FBa0I7QUFBQSxXQUFRLEtBQUssR0FBTCxDQUFSO0FBQUEsR0FBbEI7QUFDRCxDQUZEIiwiZmlsZSI6Inhoci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQmFzaWMgWEhSIExpYnJhcnkgd2l0aCBzb21lIG5vdGlvbnMgaGFyZGNvZGVkIGluXG4gKiBvZiB3aGF0IHRoZSBMYXllciBzZXJ2ZXIgZXhwZWN0cy9yZXR1cm5zLlxuICpcbiAgICBsYXllci54aHIoe1xuICAgICAgdXJsOiAnaHR0cDovL215LmNvbS9teWRhdGEnLFxuICAgICAgZGF0YToge2hleTogJ2hvJywgdGhlcmU6ICdmb2xrJ30sXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgZm9ybWF0OiAnanNvbicsXG4gICAgICBoZWFkZXJzOiB7J2ZyZWQnOiAnSm9lJ30sXG4gICAgICB0aW1lb3V0OiA1MDAwMFxuICAgIH0sIGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgaWYgKCFyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICBlcnJvckhhbmRsZXIocmVzdWx0LmRhdGEsIHJlc3VsdC5oZWFkZXJzLCByZXN1bHQuc3RhdHVzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN1Y2Nlc3NIYW5kbGVyKHJlc3VsdC5kYXRhLCByZXN1bHQuaGVhZGVycywgcmVzdWx0Lnhocik7XG4gICAgICB9XG4gICAgfSk7XG4gKlxuICogQGNsYXNzIGxheWVyLnhoclxuICogQHByaXZhdGVcbiAqL1xuXG4vKipcbiAqIFNlbmQgYSBSZXF1ZXN0LlxuICpcbiAqIEBtZXRob2QgIHhoclxuICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNcbiAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLnVybFxuICogQHBhcmFtIHtNaXhlZH0gW29wdGlvbnMuZGF0YT1udWxsXVxuICogQHBhcmFtIHtzdHJpbmd9IFtvcHRpb25zLmZvcm1hdD0nJ10gLSBzZXQgdG8gJ2pzb24nIHRvIGdldCByZXN1bHQgcGFyc2VkIGFzIGpzb24gKGluIGNhc2UgdGhlcmUgaXMgbm8gb2J2aW91cyBDb250ZW50LVR5cGUgaW4gdGhlIHJlc3BvbnNlKVxuICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zLmhlYWRlcnM9e31dIC0gTmFtZSB2YWx1ZSBwYWlycyBmb3IgIGhlYWRlcnMgYW5kIHRoZWlyIHZhbHVlc1xuICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLnRpbWVvdXQ9MF0gLSBXaGVuIGRvZXMgdGhlIHJlcXVlc3QgZXhwaXJlL3RpbWVvdXQgaW4gbWlsaXNlY29uZHMuXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFja1xuICogQHBhcmFtIHtPYmplY3R9IGNhbGxiYWNrLnJlc3VsdFxuICogQHBhcmFtIHtudW1iZXJ9IGNhbGxiYWNrLnJlc3VsdC5zdGF0dXMgLSBodHRwIHN0YXR1cyBjb2RlXG4gKiBAcGFyYW0ge2Jvb2xlYW59IGNhbGxiYWNrLnJlc3VsdC5zdWNjZXNzIC0gdHJ1ZSBpZiBpdCB3YXMgYSBzdWNjZXNzZnVsIHJlc3BvbnNlXG4gKiBAcGFyYW0ge1hNTEh0dHBSZXF1ZXN0fSBjYWxsYmFjay5yZXN1bHQueGhyIC0gVGhlIFhIUiBvYmplY3QgdXNlZCBmb3IgdGhlIHJlcXVlc3RcbiAqIEBwYXJhbSB7T2JqZWN0fSBjYWxsYmFjay5yZXN1bHQuZGF0YSAtICBUaGUgcGFyc2VkIHJlc3BvbnNlIGJvZHlcbiAqXG4gKiBUT0RPOlxuICpcbiAqIDEuIE1ha2UgdGhpcyBhIHN1YmNsYXNzIG9mIFJvb3QgYW5kIG1ha2UgaXQgYSBzaW5nbGV0b24gc28gaXQgY2FuIGluaGVyaXQgYSBwcm9wZXIgZXZlbnQgc3lzdGVtXG4gKiAyLiBSZXN1bHQgc2hvdWxkIGJlIGEgbGF5ZXIuU2VydmVyUmVzcG9uc2UgaW5zdGFuY2VcbiAqIDMuIFNob3VsZCBvbmx5IGFjY2VzcyBsaW5rIGhlYWRlcnMgaWYgcmVxdWVzdGVkOyBhbm5veWluZyBoYXZpbmcgaXQgdGhyb3cgZXJyb3JzIGV2ZXJ5IG90aGVyIHRpbWUuXG4gKi9cblxuLy8gRG9uJ3Qgc2V0IHhociB0byB3aW5kb3cuWE1MSHR0cFJlcXVlc3QgYXMgaXQgd2lsbCBieXBhc3MgamFzbWluZSdzXG4vLyBhamF4IGxpYnJhcnlcbmNvbnN0IFhociA9ICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJykgPyByZXF1aXJlKCd4aHIyJykgOiBudWxsO1xuXG5mdW5jdGlvbiBwYXJzZUxpbmtIZWFkZXJzKGxpbmtIZWFkZXIpIHtcbiAgaWYgKCFsaW5rSGVhZGVyKSByZXR1cm4ge307XG5cbiAgLy8gU3BsaXQgcGFydHMgYnkgY29tbWFcbiAgY29uc3QgcGFydHMgPSBsaW5rSGVhZGVyLnNwbGl0KCcsJyk7XG4gIGNvbnN0IGxpbmtzID0ge307XG5cbiAgLy8gUGFyc2UgZWFjaCBwYXJ0IGludG8gYSBuYW1lZCBsaW5rXG4gIHBhcnRzLmZvckVhY2goKHBhcnQpID0+IHtcbiAgICBjb25zdCBzZWN0aW9uID0gcGFydC5zcGxpdCgnOycpO1xuICAgIGlmIChzZWN0aW9uLmxlbmd0aCAhPT0gMikgcmV0dXJuO1xuICAgIGNvbnN0IHVybCA9IHNlY3Rpb25bMF0ucmVwbGFjZSgvPCguKik+LywgJyQxJykudHJpbSgpO1xuICAgIGNvbnN0IG5hbWUgPSBzZWN0aW9uWzFdLnJlcGxhY2UoL3JlbD0nPyguKiknPy8sICckMScpLnRyaW0oKTtcbiAgICBsaW5rc1tuYW1lXSA9IHVybDtcbiAgfSk7XG5cbiAgcmV0dXJuIGxpbmtzO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IChyZXF1ZXN0LCBjYWxsYmFjaykgPT4ge1xuICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICBjb25zdCByZXEgPSBYaHIgPyBuZXcgWGhyKCkgOiBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgY29uc3QgbWV0aG9kID0gKHJlcXVlc3QubWV0aG9kIHx8ICdHRVQnKS50b1VwcGVyQ2FzZSgpO1xuXG4gIGNvbnN0IG9ubG9hZCA9IGZ1bmN0aW9uIG9ubG9hZCgpIHtcbiAgICBjb25zdCBoZWFkZXJzID0ge1xuICAgICAgJ2NvbnRlbnQtdHlwZSc6IHRoaXMuZ2V0UmVzcG9uc2VIZWFkZXIoJ2NvbnRlbnQtdHlwZScpLFxuICAgIH07XG5cbiAgICBjb25zdCByZXN1bHQgPSB7XG4gICAgICBzdGF0dXM6IHRoaXMuc3RhdHVzLFxuICAgICAgc3VjY2VzczogdGhpcy5zdGF0dXMgJiYgdGhpcy5zdGF0dXMgPCAzMDAsXG4gICAgICB4aHI6IHRoaXMsXG4gICAgfTtcblxuICAgIGNvbnN0IGlzSlNPTiA9IChTdHJpbmcoaGVhZGVyc1snY29udGVudC10eXBlJ10pLnNwbGl0KC87LylbMF0ubWF0Y2goL15hcHBsaWNhdGlvblxcL2pzb24vKSB8fFxuICAgICAgICAgICByZXF1ZXN0LmZvcm1hdCA9PT0gJ2pzb24nKTtcblxuICAgIGlmICh0aGlzLnJlc3BvbnNlVHlwZSA9PT0gJ2Jsb2InIHx8IHRoaXMucmVzcG9uc2VUeXBlID09PSAnYXJyYXlidWZmZXInKSB7XG4gICAgICBpZiAodGhpcy5zdGF0dXMgPT09IDApIHtcbiAgICAgICAgcmVzdWx0LmRhdGEgPSBuZXcgRXJyb3IoJ0Nvbm5lY3Rpb24gRmFpbGVkJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBEYW1uaXQsIHRoaXMucmVzcG9uc2UgaXMgYSBmdW5jdGlvbiBpZiB1c2luZyBqYXNtaW5lIHRlc3QgZnJhbWV3b3JrLlxuICAgICAgICByZXN1bHQuZGF0YSA9IHR5cGVvZiB0aGlzLnJlc3BvbnNlID09PSAnZnVuY3Rpb24nID8gdGhpcy5yZXNwb25zZVRleHQgOiB0aGlzLnJlc3BvbnNlO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoaXNKU09OICYmIHRoaXMucmVzcG9uc2VUZXh0KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgcmVzdWx0LmRhdGEgPSBKU09OLnBhcnNlKHRoaXMucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgcmVzdWx0LmRhdGEgPSB7XG4gICAgICAgICAgICBjb2RlOiA5OTksXG4gICAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBKU09OIGZyb20gc2VydmVyJyxcbiAgICAgICAgICAgIHJlc3BvbnNlOiB0aGlzLnJlc3BvbnNlVGV4dCxcbiAgICAgICAgICB9O1xuICAgICAgICAgIHJlc3VsdC5zdGF0dXMgPSA5OTk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdC5kYXRhID0gdGhpcy5yZXNwb25zZVRleHQ7XG4gICAgICB9XG5cbiAgICAgIC8vIE5vdGUgdGhhdCBpdCBpcyBhIHN1Y2Nlc3NmdWwgY29ubmVjdGlvbiBpZiB3ZSBnZXQgYmFjayBhbiBlcnJvciBmcm9tIHRoZSBzZXJ2ZXIsXG4gICAgICAvLyBpdCBtYXkgaGF2ZSBiZWVuIGEgZmFpbGVkIHJlcXVlc3QsIGJ1dCB0aGUgY29ubmVjdGlvbiB3YXMgZ29vZC5cbiAgICAgIG1vZHVsZS5leHBvcnRzLnRyaWdnZXIoe1xuICAgICAgICB0YXJnZXQ6IHRoaXMsXG4gICAgICAgIHN0YXR1czogIXRoaXMucmVzcG9uc2VUZXh0ICYmICF0aGlzLnN0YXR1cyA/ICdjb25uZWN0aW9uOmVycm9yJyA6ICdjb25uZWN0aW9uOnN1Y2Nlc3MnLFxuICAgICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIXRoaXMucmVzcG9uc2VUZXh0ICYmICF0aGlzLnN0YXR1cykge1xuICAgICAgICByZXN1bHQuc3RhdHVzID0gNDA4O1xuICAgICAgICByZXN1bHQuZGF0YSA9IHtcbiAgICAgICAgICBpZDogJ3JlcXVlc3RfdGltZW91dCcsXG4gICAgICAgICAgbWVzc2FnZTogJ1RoZSBzZXJ2ZXIgaXMgbm90IHJlc3BvbmRpbmcgcGxlYXNlIHRyeSBhZ2FpbiBpbiBhIGZldyBtaW51dGVzJyxcbiAgICAgICAgICB1cmw6ICdodHRwczovL2RvY3MubGF5ZXIuY29tL3JlZmVyZW5jZS9jbGllbnRfYXBpL2Vycm9ycycsXG4gICAgICAgICAgY29kZTogMCxcbiAgICAgICAgICBzdGF0dXM6IDQwOCxcbiAgICAgICAgICBodHRwU3RhdHVzOiA0MDgsXG4gICAgICAgIH07XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdHVzID09PSA0MDQgJiYgdHlwZW9mIHJlc3VsdC5kYXRhICE9PSAnb2JqZWN0Jykge1xuICAgICAgICByZXN1bHQuZGF0YSA9IHtcbiAgICAgICAgICBpZDogJ29wZXJhdGlvbl9ub3RfZm91bmQnLFxuICAgICAgICAgIG1lc3NhZ2U6ICdFbmRwb2ludCAnICsgKHJlcXVlc3QubWV0aG9kIHx8ICdHRVQnKSArICcgJyArIHJlcXVlc3QudXJsICsgJyBkb2VzIG5vdCBleGlzdCcsXG4gICAgICAgICAgc3RhdHVzOiB0aGlzLnN0YXR1cyxcbiAgICAgICAgICBodHRwU3RhdHVzOiA0MDQsXG4gICAgICAgICAgY29kZTogMTA2LFxuICAgICAgICAgIHVybDogJ2h0dHBzOi8vZG9jcy5sYXllci5jb20vcmVmZXJlbmNlL2NsaWVudF9hcGkvZXJyb3JzJyxcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlc3VsdC5kYXRhID09PSAnc3RyaW5nJyAmJiB0aGlzLnN0YXR1cyA+PSA0MDApIHtcbiAgICAgICAgcmVzdWx0LmRhdGEgPSB7XG4gICAgICAgICAgaWQ6ICd1bmtub3duX2Vycm9yJyxcbiAgICAgICAgICBtZXNzYWdlOiByZXN1bHQuZGF0YSxcbiAgICAgICAgICBzdGF0dXM6IHRoaXMuc3RhdHVzLFxuICAgICAgICAgIGh0dHBTdGF0dXM6IHRoaXMuc3RhdHVzLFxuICAgICAgICAgIGNvZGU6IDAsXG4gICAgICAgICAgdXJsOiAnaHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS9zZWFyY2g/cT1kb2ghJyxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocmVxdWVzdC5oZWFkZXJzICYmIChyZXF1ZXN0LmhlYWRlcnMuYWNjZXB0IHx8ICcnKS5tYXRjaCgvYXBwbGljYXRpb25cXC92bmQubGF5ZXJcXCtqc29uLykpIHtcbiAgICAgIGNvbnN0IGxpbmtzID0gdGhpcy5nZXRSZXNwb25zZUhlYWRlcignbGluaycpO1xuICAgICAgaWYgKGxpbmtzKSByZXN1bHQuTGlua3MgPSBwYXJzZUxpbmtIZWFkZXJzKGxpbmtzKTtcbiAgICB9XG4gICAgcmVzdWx0LnhociA9IHRoaXM7XG5cbiAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKHJlc3VsdCk7XG4gIH07XG5cbiAgcmVxLm9ubG9hZCA9IG9ubG9hZDtcblxuICAvLyBVTlRFU1RFRCEhIVxuICByZXEub25lcnJvciA9IHJlcS5vbnRpbWVvdXQgPSBvbmxvYWQ7XG5cbiAgLy8gUmVwbGFjZSBhbGwgaGVhZGVycyBpbiBhcmJpdHJhcnkgY2FzZSB3aXRoIGFsbCBsb3dlciBjYXNlXG4gIC8vIGZvciBlYXN5IG1hdGNoaW5nLlxuICBjb25zdCBoZWFkZXJzTGlzdCA9IE9iamVjdC5rZXlzKHJlcXVlc3QuaGVhZGVycyB8fCB7fSk7XG4gIGNvbnN0IGhlYWRlcnMgPSB7fTtcbiAgaGVhZGVyc0xpc3QuZm9yRWFjaCgoaGVhZGVyKSA9PiB7XG4gICAgaWYgKGhlYWRlci50b0xvd2VyQ2FzZSgpID09PSAnY29udGVudC10eXBlJykge1xuICAgICAgaGVhZGVyc1snY29udGVudC10eXBlJ10gPSByZXF1ZXN0LmhlYWRlcnNbaGVhZGVyXTtcbiAgICB9IGVsc2Uge1xuICAgICAgaGVhZGVyc1toZWFkZXIudG9Mb3dlckNhc2UoKV0gPSByZXF1ZXN0LmhlYWRlcnNbaGVhZGVyXTtcbiAgICB9XG4gIH0pO1xuICByZXF1ZXN0LmhlYWRlcnMgPSBoZWFkZXJzO1xuXG4gIGxldCBkYXRhID0gJyc7XG4gIGlmIChyZXF1ZXN0LmRhdGEpIHtcbiAgICBpZiAodHlwZW9mIEJsb2IgIT09ICd1bmRlZmluZWQnICYmIHJlcXVlc3QuZGF0YSBpbnN0YW5jZW9mIEJsb2IpIHtcbiAgICAgIGRhdGEgPSByZXF1ZXN0LmRhdGE7XG4gICAgfSBlbHNlIGlmIChyZXF1ZXN0LmhlYWRlcnMgJiYgKFxuICAgICAgICBTdHJpbmcocmVxdWVzdC5oZWFkZXJzWydjb250ZW50LXR5cGUnXSkubWF0Y2goL15hcHBsaWNhdGlvblxcL2pzb24vKSB8fFxuICAgICAgICBTdHJpbmcocmVxdWVzdC5oZWFkZXJzWydjb250ZW50LXR5cGUnXSkgPT09ICdhcHBsaWNhdGlvbi92bmQubGF5ZXItcGF0Y2granNvbicpXG4gICAgKSB7XG4gICAgICBkYXRhID0gdHlwZW9mIHJlcXVlc3QuZGF0YSA9PT0gJ3N0cmluZycgPyByZXF1ZXN0LmRhdGEgOiBKU09OLnN0cmluZ2lmeShyZXF1ZXN0LmRhdGEpO1xuICAgIH0gZWxzZSBpZiAocmVxdWVzdC5kYXRhICYmIHR5cGVvZiByZXF1ZXN0LmRhdGEgPT09ICdvYmplY3QnKSB7XG4gICAgICBPYmplY3Qua2V5cyhyZXF1ZXN0LmRhdGEpLmZvckVhY2goKG5hbWUpID0+IHtcbiAgICAgICAgaWYgKGRhdGEpIGRhdGEgKz0gJyYnO1xuICAgICAgICBkYXRhICs9IG5hbWUgKyAnPScgKyByZXF1ZXN0LmRhdGFbbmFtZV07XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGF0YSA9IHJlcXVlc3QuZGF0YTsgLy8gU29tZSBmb3JtIG9mIHJhdyBzdHJpbmcvZGF0YVxuICAgIH1cbiAgfVxuICBpZiAoZGF0YSkge1xuICAgIGlmIChtZXRob2QgPT09ICdHRVQnKSB7XG4gICAgICByZXF1ZXN0LnVybCArPSAnPycgKyBkYXRhO1xuICAgIH1cbiAgfVxuXG4gIHJlcS5vcGVuKG1ldGhvZCwgcmVxdWVzdC51cmwsIHRydWUpO1xuICBpZiAocmVxdWVzdC50aW1lb3V0KSByZXEudGltZW91dCA9IHJlcXVlc3QudGltZW91dDtcbiAgaWYgKHJlcXVlc3Qud2l0aENyZWRlbnRpYWxzKSByZXEud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTtcbiAgaWYgKHJlcXVlc3QucmVzcG9uc2VUeXBlKSByZXEucmVzcG9uc2VUeXBlID0gcmVxdWVzdC5yZXNwb25zZVR5cGU7XG5cbiAgaWYgKHJlcXVlc3QuaGVhZGVycykge1xuICAgIE9iamVjdC5rZXlzKHJlcXVlc3QuaGVhZGVycykuZm9yRWFjaChoZWFkZXJOYW1lID0+IHJlcS5zZXRSZXF1ZXN0SGVhZGVyKGhlYWRlck5hbWUsIHJlcXVlc3QuaGVhZGVyc1toZWFkZXJOYW1lXSkpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBpZiAobWV0aG9kID09PSAnR0VUJykge1xuICAgICAgcmVxLnNlbmQoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVxLnNlbmQoZGF0YSk7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgLy8gZG8gbm90aGluZ1xuICB9XG59O1xuXG5jb25zdCBsaXN0ZW5lcnMgPSBbXTtcbm1vZHVsZS5leHBvcnRzLmFkZENvbm5lY3Rpb25MaXN0ZW5lciA9IGZ1bmMgPT4gbGlzdGVuZXJzLnB1c2goZnVuYyk7XG5cbm1vZHVsZS5leHBvcnRzLnRyaWdnZXIgPSAoZXZ0KSA9PiB7XG4gIGxpc3RlbmVycy5mb3JFYWNoKGZ1bmMgPT4gZnVuYyhldnQpKTtcbn07XG4iXX0=
