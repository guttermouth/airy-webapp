'use strict';

/**
 *
 * Adds Query handling to the layer.Client.
 *
 * @class layer.mixins.ClientQueries
 */

var Query = require('../queries/query');
var IdentitiesQuery = require('../queries/identities-query');
var ConversationsQuery = require('../queries/conversations-query');
var ChannelsQuery = require('../queries/channels-query');
var MembersQuery = require('../queries/members-query');
var MessagesQuery = require('../queries/messages-query');
var AnnouncementsQuery = require('../queries/announcements-query');
var ErrorDictionary = require('../layer-error').dictionary;

module.exports = {
  events: [],
  lifecycle: {
    constructor: function constructor(options) {
      this._models.queries = {};
    },
    cleanup: function cleanup() {
      var _this = this;

      Object.keys(this._models.queries).forEach(function (id) {
        var query = _this._models.queries[id];
        if (query && !query.isDestroyed) {
          query.destroy();
        }
      });
      this._models.queries = null;
    },
    reset: function reset() {
      this._models.queries = {};
    }
  },
  methods: {
    /**
     * Retrieve the query by query id.
     *
     * Useful for finding a Query when you only have the ID
     *
     * @method getQuery
     * @param  {string} id              - layer:///queries/uuid
     * @return {layer.Query}
     */
    getQuery: function getQuery(id) {
      if (typeof id !== 'string') throw new Error(ErrorDictionary.idParamRequired);
      return this._models.queries[id] || null;
    },


    /**
     * There are two options to create a new layer.Query instance.
     *
     * The direct way:
     *
     *     var query = client.createQuery({
     *         model: layer.Query.Message,
     *         predicate: 'conversation.id = '' + conv.id + ''',
     *         paginationWindow: 50
     *     });
     *
     * A Builder approach that allows for a simpler syntax:
     *
     *     var qBuilder = QueryBuilder
     *      .messages()
     *      .forConversation('layer:///conversations/ffffffff-ffff-ffff-ffff-ffffffffffff')
     *      .paginationWindow(100);
     *     var query = client.createQuery(qBuilder);
     *
     * @method createQuery
     * @param  {layer.QueryBuilder|Object} options - Either a layer.QueryBuilder instance, or parameters for the layer.Query constructor
     * @return {layer.Query}
     */
    createQuery: function createQuery(options) {
      var query = void 0;

      if (typeof options.build === 'function') {
        options = options.build();
      }
      options.client = this;
      switch (options.model) {
        case Query.Identity:
          query = new IdentitiesQuery(options);
          break;
        case Query.Conversation:
          query = new ConversationsQuery(options);
          break;
        case Query.Channel:
          query = new ChannelsQuery(options);
          break;
        case Query.Membership:
          query = new MembersQuery(options);
          break;
        case Query.Message:
          query = new MessagesQuery(options);
          break;
        case Query.Announcement:
          query = new AnnouncementsQuery(options);
          break;

        default:
          query = new Query(options);
      }
      this._addQuery(query);
      return query;
    },


    /**
     * Register the layer.Query.
     *
     * @method _addQuery
     * @private
     * @param  {layer.Query} query
     */
    _addQuery: function _addQuery(query) {
      this._models.queries[query.id] = query;
    },


    /**
     * Deregister the layer.Query.
     *
     * @method _removeQuery
     * @private
     * @param  {layer.Query} query [description]
     */
    _removeQuery: function _removeQuery(query) {
      var _this2 = this;

      if (query) {
        delete this._models.queries[query.id];
        if (!this._inCleanup) {
          var data = query.data.map(function (obj) {
            return _this2.getObject(obj.id);
          }).filter(function (obj) {
            return obj;
          });
          this._checkAndPurgeCache(data);
        }
        this.off(null, null, query);
      }
    }
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taXhpbnMvY2xpZW50LXF1ZXJpZXMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7OztBQU9BLElBQU0sUUFBUSxRQUFRLGtCQUFSLENBQWQ7QUFDQSxJQUFNLGtCQUFrQixRQUFRLDZCQUFSLENBQXhCO0FBQ0EsSUFBTSxxQkFBcUIsUUFBUSxnQ0FBUixDQUEzQjtBQUNBLElBQU0sZ0JBQWdCLFFBQVEsMkJBQVIsQ0FBdEI7QUFDQSxJQUFNLGVBQWUsUUFBUSwwQkFBUixDQUFyQjtBQUNBLElBQU0sZ0JBQWdCLFFBQVEsMkJBQVIsQ0FBdEI7QUFDQSxJQUFNLHFCQUFxQixRQUFRLGdDQUFSLENBQTNCO0FBQ0EsSUFBTSxrQkFBa0IsUUFBUSxnQkFBUixFQUEwQixVQUFsRDs7QUFFQSxPQUFPLE9BQVAsR0FBaUI7QUFDZixVQUFRLEVBRE87QUFJZixhQUFXO0FBQ1QsZUFEUyx1QkFDRyxPQURILEVBQ1k7QUFDbkIsV0FBSyxPQUFMLENBQWEsT0FBYixHQUF1QixFQUF2QjtBQUNELEtBSFE7QUFJVCxXQUpTLHFCQUlDO0FBQUE7O0FBQ1IsYUFBTyxJQUFQLENBQVksS0FBSyxPQUFMLENBQWEsT0FBekIsRUFBa0MsT0FBbEMsQ0FBMEMsVUFBQyxFQUFELEVBQVE7QUFDaEQsWUFBTSxRQUFRLE1BQUssT0FBTCxDQUFhLE9BQWIsQ0FBcUIsRUFBckIsQ0FBZDtBQUNBLFlBQUksU0FBUyxDQUFDLE1BQU0sV0FBcEIsRUFBaUM7QUFDL0IsZ0JBQU0sT0FBTjtBQUNEO0FBQ0YsT0FMRDtBQU1BLFdBQUssT0FBTCxDQUFhLE9BQWIsR0FBdUIsSUFBdkI7QUFDRCxLQVpRO0FBYVQsU0FiUyxtQkFhRDtBQUNOLFdBQUssT0FBTCxDQUFhLE9BQWIsR0FBdUIsRUFBdkI7QUFDRDtBQWZRLEdBSkk7QUFzQmYsV0FBUztBQUNQOzs7Ozs7Ozs7QUFTQSxZQVZPLG9CQVVFLEVBVkYsRUFVTTtBQUNYLFVBQUksT0FBTyxFQUFQLEtBQWMsUUFBbEIsRUFBNEIsTUFBTSxJQUFJLEtBQUosQ0FBVSxnQkFBZ0IsZUFBMUIsQ0FBTjtBQUM1QixhQUFPLEtBQUssT0FBTCxDQUFhLE9BQWIsQ0FBcUIsRUFBckIsS0FBNEIsSUFBbkM7QUFDRCxLQWJNOzs7QUFlUDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUF1QkEsZUF0Q08sdUJBc0NLLE9BdENMLEVBc0NjO0FBQ25CLFVBQUksY0FBSjs7QUFFQSxVQUFJLE9BQU8sUUFBUSxLQUFmLEtBQXlCLFVBQTdCLEVBQXlDO0FBQ3ZDLGtCQUFVLFFBQVEsS0FBUixFQUFWO0FBQ0Q7QUFDRCxjQUFRLE1BQVIsR0FBaUIsSUFBakI7QUFDQSxjQUFRLFFBQVEsS0FBaEI7QUFDRSxhQUFLLE1BQU0sUUFBWDtBQUNFLGtCQUFRLElBQUksZUFBSixDQUFvQixPQUFwQixDQUFSO0FBQ0E7QUFDRixhQUFLLE1BQU0sWUFBWDtBQUNFLGtCQUFRLElBQUksa0JBQUosQ0FBdUIsT0FBdkIsQ0FBUjtBQUNBO0FBQ0YsYUFBSyxNQUFNLE9BQVg7QUFDRSxrQkFBUSxJQUFJLGFBQUosQ0FBa0IsT0FBbEIsQ0FBUjtBQUNBO0FBQ0YsYUFBSyxNQUFNLFVBQVg7QUFDRSxrQkFBUSxJQUFJLFlBQUosQ0FBaUIsT0FBakIsQ0FBUjtBQUNBO0FBQ0YsYUFBSyxNQUFNLE9BQVg7QUFDRSxrQkFBUSxJQUFJLGFBQUosQ0FBa0IsT0FBbEIsQ0FBUjtBQUNBO0FBQ0YsYUFBSyxNQUFNLFlBQVg7QUFDRSxrQkFBUSxJQUFJLGtCQUFKLENBQXVCLE9BQXZCLENBQVI7QUFDQTs7QUFFRjtBQUNFLGtCQUFRLElBQUksS0FBSixDQUFVLE9BQVYsQ0FBUjtBQXJCSjtBQXVCQSxXQUFLLFNBQUwsQ0FBZSxLQUFmO0FBQ0EsYUFBTyxLQUFQO0FBQ0QsS0F0RU07OztBQXdFUDs7Ozs7OztBQU9BLGFBL0VPLHFCQStFRyxLQS9FSCxFQStFVTtBQUNmLFdBQUssT0FBTCxDQUFhLE9BQWIsQ0FBcUIsTUFBTSxFQUEzQixJQUFpQyxLQUFqQztBQUNELEtBakZNOzs7QUFtRlA7Ozs7Ozs7QUFPQSxnQkExRk8sd0JBMEZNLEtBMUZOLEVBMEZhO0FBQUE7O0FBQ2xCLFVBQUksS0FBSixFQUFXO0FBQ1QsZUFBTyxLQUFLLE9BQUwsQ0FBYSxPQUFiLENBQXFCLE1BQU0sRUFBM0IsQ0FBUDtBQUNBLFlBQUksQ0FBQyxLQUFLLFVBQVYsRUFBc0I7QUFDcEIsY0FBTSxPQUFPLE1BQU0sSUFBTixDQUNWLEdBRFUsQ0FDTjtBQUFBLG1CQUFPLE9BQUssU0FBTCxDQUFlLElBQUksRUFBbkIsQ0FBUDtBQUFBLFdBRE0sRUFFVixNQUZVLENBRUg7QUFBQSxtQkFBTyxHQUFQO0FBQUEsV0FGRyxDQUFiO0FBR0EsZUFBSyxtQkFBTCxDQUF5QixJQUF6QjtBQUNEO0FBQ0QsYUFBSyxHQUFMLENBQVMsSUFBVCxFQUFlLElBQWYsRUFBcUIsS0FBckI7QUFDRDtBQUNGO0FBckdNO0FBdEJNLENBQWpCIiwiZmlsZSI6ImNsaWVudC1xdWVyaWVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKlxuICogQWRkcyBRdWVyeSBoYW5kbGluZyB0byB0aGUgbGF5ZXIuQ2xpZW50LlxuICpcbiAqIEBjbGFzcyBsYXllci5taXhpbnMuQ2xpZW50UXVlcmllc1xuICovXG5cbmNvbnN0IFF1ZXJ5ID0gcmVxdWlyZSgnLi4vcXVlcmllcy9xdWVyeScpO1xuY29uc3QgSWRlbnRpdGllc1F1ZXJ5ID0gcmVxdWlyZSgnLi4vcXVlcmllcy9pZGVudGl0aWVzLXF1ZXJ5Jyk7XG5jb25zdCBDb252ZXJzYXRpb25zUXVlcnkgPSByZXF1aXJlKCcuLi9xdWVyaWVzL2NvbnZlcnNhdGlvbnMtcXVlcnknKTtcbmNvbnN0IENoYW5uZWxzUXVlcnkgPSByZXF1aXJlKCcuLi9xdWVyaWVzL2NoYW5uZWxzLXF1ZXJ5Jyk7XG5jb25zdCBNZW1iZXJzUXVlcnkgPSByZXF1aXJlKCcuLi9xdWVyaWVzL21lbWJlcnMtcXVlcnknKTtcbmNvbnN0IE1lc3NhZ2VzUXVlcnkgPSByZXF1aXJlKCcuLi9xdWVyaWVzL21lc3NhZ2VzLXF1ZXJ5Jyk7XG5jb25zdCBBbm5vdW5jZW1lbnRzUXVlcnkgPSByZXF1aXJlKCcuLi9xdWVyaWVzL2Fubm91bmNlbWVudHMtcXVlcnknKTtcbmNvbnN0IEVycm9yRGljdGlvbmFyeSA9IHJlcXVpcmUoJy4uL2xheWVyLWVycm9yJykuZGljdGlvbmFyeTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGV2ZW50czogW1xuXG4gIF0sXG4gIGxpZmVjeWNsZToge1xuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHtcbiAgICAgIHRoaXMuX21vZGVscy5xdWVyaWVzID0ge307XG4gICAgfSxcbiAgICBjbGVhbnVwKCkge1xuICAgICAgT2JqZWN0LmtleXModGhpcy5fbW9kZWxzLnF1ZXJpZXMpLmZvckVhY2goKGlkKSA9PiB7XG4gICAgICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5fbW9kZWxzLnF1ZXJpZXNbaWRdO1xuICAgICAgICBpZiAocXVlcnkgJiYgIXF1ZXJ5LmlzRGVzdHJveWVkKSB7XG4gICAgICAgICAgcXVlcnkuZGVzdHJveSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMuX21vZGVscy5xdWVyaWVzID0gbnVsbDtcbiAgICB9LFxuICAgIHJlc2V0KCkge1xuICAgICAgdGhpcy5fbW9kZWxzLnF1ZXJpZXMgPSB7fTtcbiAgICB9LFxuXG4gIH0sXG4gIG1ldGhvZHM6IHtcbiAgICAvKipcbiAgICAgKiBSZXRyaWV2ZSB0aGUgcXVlcnkgYnkgcXVlcnkgaWQuXG4gICAgICpcbiAgICAgKiBVc2VmdWwgZm9yIGZpbmRpbmcgYSBRdWVyeSB3aGVuIHlvdSBvbmx5IGhhdmUgdGhlIElEXG4gICAgICpcbiAgICAgKiBAbWV0aG9kIGdldFF1ZXJ5XG4gICAgICogQHBhcmFtICB7c3RyaW5nfSBpZCAgICAgICAgICAgICAgLSBsYXllcjovLy9xdWVyaWVzL3V1aWRcbiAgICAgKiBAcmV0dXJuIHtsYXllci5RdWVyeX1cbiAgICAgKi9cbiAgICBnZXRRdWVyeShpZCkge1xuICAgICAgaWYgKHR5cGVvZiBpZCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihFcnJvckRpY3Rpb25hcnkuaWRQYXJhbVJlcXVpcmVkKTtcbiAgICAgIHJldHVybiB0aGlzLl9tb2RlbHMucXVlcmllc1tpZF0gfHwgbnVsbDtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogVGhlcmUgYXJlIHR3byBvcHRpb25zIHRvIGNyZWF0ZSBhIG5ldyBsYXllci5RdWVyeSBpbnN0YW5jZS5cbiAgICAgKlxuICAgICAqIFRoZSBkaXJlY3Qgd2F5OlxuICAgICAqXG4gICAgICogICAgIHZhciBxdWVyeSA9IGNsaWVudC5jcmVhdGVRdWVyeSh7XG4gICAgICogICAgICAgICBtb2RlbDogbGF5ZXIuUXVlcnkuTWVzc2FnZSxcbiAgICAgKiAgICAgICAgIHByZWRpY2F0ZTogJ2NvbnZlcnNhdGlvbi5pZCA9ICcnICsgY29udi5pZCArICcnJyxcbiAgICAgKiAgICAgICAgIHBhZ2luYXRpb25XaW5kb3c6IDUwXG4gICAgICogICAgIH0pO1xuICAgICAqXG4gICAgICogQSBCdWlsZGVyIGFwcHJvYWNoIHRoYXQgYWxsb3dzIGZvciBhIHNpbXBsZXIgc3ludGF4OlxuICAgICAqXG4gICAgICogICAgIHZhciBxQnVpbGRlciA9IFF1ZXJ5QnVpbGRlclxuICAgICAqICAgICAgLm1lc3NhZ2VzKClcbiAgICAgKiAgICAgIC5mb3JDb252ZXJzYXRpb24oJ2xheWVyOi8vL2NvbnZlcnNhdGlvbnMvZmZmZmZmZmYtZmZmZi1mZmZmLWZmZmYtZmZmZmZmZmZmZmZmJylcbiAgICAgKiAgICAgIC5wYWdpbmF0aW9uV2luZG93KDEwMCk7XG4gICAgICogICAgIHZhciBxdWVyeSA9IGNsaWVudC5jcmVhdGVRdWVyeShxQnVpbGRlcik7XG4gICAgICpcbiAgICAgKiBAbWV0aG9kIGNyZWF0ZVF1ZXJ5XG4gICAgICogQHBhcmFtICB7bGF5ZXIuUXVlcnlCdWlsZGVyfE9iamVjdH0gb3B0aW9ucyAtIEVpdGhlciBhIGxheWVyLlF1ZXJ5QnVpbGRlciBpbnN0YW5jZSwgb3IgcGFyYW1ldGVycyBmb3IgdGhlIGxheWVyLlF1ZXJ5IGNvbnN0cnVjdG9yXG4gICAgICogQHJldHVybiB7bGF5ZXIuUXVlcnl9XG4gICAgICovXG4gICAgY3JlYXRlUXVlcnkob3B0aW9ucykge1xuICAgICAgbGV0IHF1ZXJ5O1xuXG4gICAgICBpZiAodHlwZW9mIG9wdGlvbnMuYnVpbGQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMuYnVpbGQoKTtcbiAgICAgIH1cbiAgICAgIG9wdGlvbnMuY2xpZW50ID0gdGhpcztcbiAgICAgIHN3aXRjaCAob3B0aW9ucy5tb2RlbCkge1xuICAgICAgICBjYXNlIFF1ZXJ5LklkZW50aXR5OlxuICAgICAgICAgIHF1ZXJ5ID0gbmV3IElkZW50aXRpZXNRdWVyeShvcHRpb25zKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBRdWVyeS5Db252ZXJzYXRpb246XG4gICAgICAgICAgcXVlcnkgPSBuZXcgQ29udmVyc2F0aW9uc1F1ZXJ5KG9wdGlvbnMpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFF1ZXJ5LkNoYW5uZWw6XG4gICAgICAgICAgcXVlcnkgPSBuZXcgQ2hhbm5lbHNRdWVyeShvcHRpb25zKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBRdWVyeS5NZW1iZXJzaGlwOlxuICAgICAgICAgIHF1ZXJ5ID0gbmV3IE1lbWJlcnNRdWVyeShvcHRpb25zKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBRdWVyeS5NZXNzYWdlOlxuICAgICAgICAgIHF1ZXJ5ID0gbmV3IE1lc3NhZ2VzUXVlcnkob3B0aW9ucyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgUXVlcnkuQW5ub3VuY2VtZW50OlxuICAgICAgICAgIHF1ZXJ5ID0gbmV3IEFubm91bmNlbWVudHNRdWVyeShvcHRpb25zKTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHF1ZXJ5ID0gbmV3IFF1ZXJ5KG9wdGlvbnMpO1xuICAgICAgfVxuICAgICAgdGhpcy5fYWRkUXVlcnkocXVlcnkpO1xuICAgICAgcmV0dXJuIHF1ZXJ5O1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZWdpc3RlciB0aGUgbGF5ZXIuUXVlcnkuXG4gICAgICpcbiAgICAgKiBAbWV0aG9kIF9hZGRRdWVyeVxuICAgICAqIEBwcml2YXRlXG4gICAgICogQHBhcmFtICB7bGF5ZXIuUXVlcnl9IHF1ZXJ5XG4gICAgICovXG4gICAgX2FkZFF1ZXJ5KHF1ZXJ5KSB7XG4gICAgICB0aGlzLl9tb2RlbHMucXVlcmllc1txdWVyeS5pZF0gPSBxdWVyeTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRGVyZWdpc3RlciB0aGUgbGF5ZXIuUXVlcnkuXG4gICAgICpcbiAgICAgKiBAbWV0aG9kIF9yZW1vdmVRdWVyeVxuICAgICAqIEBwcml2YXRlXG4gICAgICogQHBhcmFtICB7bGF5ZXIuUXVlcnl9IHF1ZXJ5IFtkZXNjcmlwdGlvbl1cbiAgICAgKi9cbiAgICBfcmVtb3ZlUXVlcnkocXVlcnkpIHtcbiAgICAgIGlmIChxdWVyeSkge1xuICAgICAgICBkZWxldGUgdGhpcy5fbW9kZWxzLnF1ZXJpZXNbcXVlcnkuaWRdO1xuICAgICAgICBpZiAoIXRoaXMuX2luQ2xlYW51cCkge1xuICAgICAgICAgIGNvbnN0IGRhdGEgPSBxdWVyeS5kYXRhXG4gICAgICAgICAgICAubWFwKG9iaiA9PiB0aGlzLmdldE9iamVjdChvYmouaWQpKVxuICAgICAgICAgICAgLmZpbHRlcihvYmogPT4gb2JqKTtcbiAgICAgICAgICB0aGlzLl9jaGVja0FuZFB1cmdlQ2FjaGUoZGF0YSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5vZmYobnVsbCwgbnVsbCwgcXVlcnkpO1xuICAgICAgfVxuICAgIH0sXG4gIH0sXG59O1xuIl19
