'use strict';

/**
 * Adds Channel Membership handling to the layer.Client.
 *
 * @class layer.mixins.ClientMembership
 */

var Syncable = require('../models/syncable');
var Membership = require('../models/membership');
var ErrorDictionary = require('../layer-error').dictionary;

module.exports = {
  events: [
  /**
   * A call to layer.Membership.load has completed successfully
   *
   * @event
   * @param {layer.LayerEvent} evt
   * @param {layer.Membership} evt.target
   */
  'members:loaded',

  /**
   * An Identity has had a change in its properties.
   *
   * Changes occur when new data arrives from the server.
   *
   *      client.on('members:change', function(evt) {
   *          var displayNameChanges = evt.getChangesFor('displayName');
   *          if (displayNameChanges.length) {
   *              myView.renderStatus(evt.target);
   *          }
   *      });
   *
   * @event
   * @param {layer.LayerEvent} evt
   * @param {layer.Membership} evt.target
   * @param {Object[]} evt.changes
   * @param {Mixed} evt.changes.newValue
   * @param {Mixed} evt.changes.oldValue
   * @param {string} evt.changes.property - Name of the property that has changed
   */
  'members:change',

  /**
   * A new Member has been added to the Client.
   *
   * This event is triggered whenever a new layer.Membership
   * has been received by the Client.
   *
          client.on('members:add', function(evt) {
              evt.membership.forEach(function(member) {
                  myView.addMember(member);
              });
          });
  *
  * @event
  * @param {layer.LayerEvent} evt
  * @param {layer.Membership[]} evt.membership
  */
  'members:add',

  /**
   * A Member has been removed from the Client.
   *
   * This does not typically occur.
   *
          client.on('members:remove', function(evt) {
              evt.membership.forEach(function(member) {
                  myView.addMember(member);
              });
          });
  *
  * @event
  * @param {layer.LayerEvent} evt
  * @param {layer.Membership[]} evt.membership
  */
  'members:remove'],
  lifecycle: {
    constructor: function constructor(options) {
      this._models.members = {};
    },
    cleanup: function cleanup() {
      var _this = this;

      Object.keys(this._models.members).forEach(function (id) {
        var member = _this._models.members[id];
        if (member && !member.isDestroyed) {
          member.destroy();
        }
      });
      this._models.members = null;
    },
    reset: function reset() {
      this._models.members = {};
    }
  },
  methods: {
    /**
     * Retrieve the membership info by ID.
     *
     * Not for use in typical apps.
     *
     * @method getMember
     * @param  {string} id               - layer:///channels/uuid/members/user_id
     * @param  {boolean} [canLoad=false] - Pass true to allow loading a member from the server if not found
     * @return {layer.Membership}
     */
    getMember: function getMember(id, canLoad) {
      if (typeof id !== 'string') throw new Error(ErrorDictionary.idParamRequired);

      if (this._models.members[id]) {
        return this._models.members[id];
      } else if (canLoad) {
        return Syncable.load(id, this);
      }
      return null;
    },


    /**
     * Report that a new Membership has been added.
     *
     * @method _addMembership
     * @protected
     * @param  {layer.Membership} member
     *
     */
    _addMembership: function _addMembership(member) {
      if (!this._models.members[member.id]) {
        this._models.members[member.id] = member;
        this._triggerAsync('members:add', { members: [member] });
        this._scheduleCheckAndPurgeCache(member);
      }
    },


    /**
     * Report that a member has been removed from the client.
     *
     * @method _removeMembership
     * @protected
     * @param  {layer.Membership} member
     */
    _removeMembership: function _removeMembership(member) {
      var id = typeof member === 'string' ? member : member.id;
      member = this._models.members[id];
      if (member) {
        delete this._models.members[id];
        if (!this._inCleanup) {
          member.off(null, null, this);
          this._triggerAsync('members:remove', { members: [member] });
        }
      }
    }
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taXhpbnMvY2xpZW50LW1lbWJlcnMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7O0FBTUEsSUFBTSxXQUFXLFFBQVEsb0JBQVIsQ0FBakI7QUFDQSxJQUFNLGFBQWEsUUFBUSxzQkFBUixDQUFuQjtBQUNBLElBQU0sa0JBQWtCLFFBQVEsZ0JBQVIsRUFBMEIsVUFBbEQ7O0FBRUEsT0FBTyxPQUFQLEdBQWlCO0FBQ2YsVUFBUTtBQUNOOzs7Ozs7O0FBT0Esa0JBUk07O0FBVU47Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBb0JBLGtCQTlCTTs7QUFnQ047Ozs7Ozs7Ozs7Ozs7Ozs7QUFnQkEsZUFoRE07O0FBa0ROOzs7Ozs7Ozs7Ozs7Ozs7QUFlQSxrQkFqRU0sQ0FETztBQW9FZixhQUFXO0FBQ1QsZUFEUyx1QkFDRyxPQURILEVBQ1k7QUFDbkIsV0FBSyxPQUFMLENBQWEsT0FBYixHQUF1QixFQUF2QjtBQUNELEtBSFE7QUFJVCxXQUpTLHFCQUlDO0FBQUE7O0FBQ1IsYUFBTyxJQUFQLENBQVksS0FBSyxPQUFMLENBQWEsT0FBekIsRUFBa0MsT0FBbEMsQ0FBMEMsVUFBQyxFQUFELEVBQVE7QUFDaEQsWUFBTSxTQUFTLE1BQUssT0FBTCxDQUFhLE9BQWIsQ0FBcUIsRUFBckIsQ0FBZjtBQUNBLFlBQUksVUFBVSxDQUFDLE9BQU8sV0FBdEIsRUFBbUM7QUFDakMsaUJBQU8sT0FBUDtBQUNEO0FBQ0YsT0FMRDtBQU1BLFdBQUssT0FBTCxDQUFhLE9BQWIsR0FBdUIsSUFBdkI7QUFDRCxLQVpRO0FBYVQsU0FiUyxtQkFhRDtBQUNOLFdBQUssT0FBTCxDQUFhLE9BQWIsR0FBdUIsRUFBdkI7QUFDRDtBQWZRLEdBcEVJO0FBcUZmLFdBQVM7QUFDUDs7Ozs7Ozs7OztBQVVBLGFBWE8scUJBV0csRUFYSCxFQVdPLE9BWFAsRUFXZ0I7QUFDckIsVUFBSSxPQUFPLEVBQVAsS0FBYyxRQUFsQixFQUE0QixNQUFNLElBQUksS0FBSixDQUFVLGdCQUFnQixlQUExQixDQUFOOztBQUU1QixVQUFJLEtBQUssT0FBTCxDQUFhLE9BQWIsQ0FBcUIsRUFBckIsQ0FBSixFQUE4QjtBQUM1QixlQUFPLEtBQUssT0FBTCxDQUFhLE9BQWIsQ0FBcUIsRUFBckIsQ0FBUDtBQUNELE9BRkQsTUFFTyxJQUFJLE9BQUosRUFBYTtBQUNsQixlQUFPLFNBQVMsSUFBVCxDQUFjLEVBQWQsRUFBa0IsSUFBbEIsQ0FBUDtBQUNEO0FBQ0QsYUFBTyxJQUFQO0FBQ0QsS0FwQk07OztBQXNCUDs7Ozs7Ozs7QUFRQSxrQkE5Qk8sMEJBOEJRLE1BOUJSLEVBOEJnQjtBQUNyQixVQUFJLENBQUMsS0FBSyxPQUFMLENBQWEsT0FBYixDQUFxQixPQUFPLEVBQTVCLENBQUwsRUFBc0M7QUFDcEMsYUFBSyxPQUFMLENBQWEsT0FBYixDQUFxQixPQUFPLEVBQTVCLElBQWtDLE1BQWxDO0FBQ0EsYUFBSyxhQUFMLENBQW1CLGFBQW5CLEVBQWtDLEVBQUUsU0FBUyxDQUFDLE1BQUQsQ0FBWCxFQUFsQztBQUNBLGFBQUssMkJBQUwsQ0FBaUMsTUFBakM7QUFDRDtBQUNGLEtBcENNOzs7QUFzQ1A7Ozs7Ozs7QUFPQSxxQkE3Q08sNkJBNkNXLE1BN0NYLEVBNkNtQjtBQUN4QixVQUFNLEtBQU0sT0FBTyxNQUFQLEtBQWtCLFFBQW5CLEdBQStCLE1BQS9CLEdBQXdDLE9BQU8sRUFBMUQ7QUFDQSxlQUFTLEtBQUssT0FBTCxDQUFhLE9BQWIsQ0FBcUIsRUFBckIsQ0FBVDtBQUNBLFVBQUksTUFBSixFQUFZO0FBQ1YsZUFBTyxLQUFLLE9BQUwsQ0FBYSxPQUFiLENBQXFCLEVBQXJCLENBQVA7QUFDQSxZQUFJLENBQUMsS0FBSyxVQUFWLEVBQXNCO0FBQ3BCLGlCQUFPLEdBQVAsQ0FBVyxJQUFYLEVBQWlCLElBQWpCLEVBQXVCLElBQXZCO0FBQ0EsZUFBSyxhQUFMLENBQW1CLGdCQUFuQixFQUFxQyxFQUFFLFNBQVMsQ0FBQyxNQUFELENBQVgsRUFBckM7QUFDRDtBQUNGO0FBQ0Y7QUF2RE07QUFyRk0sQ0FBakIiLCJmaWxlIjoiY2xpZW50LW1lbWJlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFkZHMgQ2hhbm5lbCBNZW1iZXJzaGlwIGhhbmRsaW5nIHRvIHRoZSBsYXllci5DbGllbnQuXG4gKlxuICogQGNsYXNzIGxheWVyLm1peGlucy5DbGllbnRNZW1iZXJzaGlwXG4gKi9cblxuY29uc3QgU3luY2FibGUgPSByZXF1aXJlKCcuLi9tb2RlbHMvc3luY2FibGUnKTtcbmNvbnN0IE1lbWJlcnNoaXAgPSByZXF1aXJlKCcuLi9tb2RlbHMvbWVtYmVyc2hpcCcpO1xuY29uc3QgRXJyb3JEaWN0aW9uYXJ5ID0gcmVxdWlyZSgnLi4vbGF5ZXItZXJyb3InKS5kaWN0aW9uYXJ5O1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgZXZlbnRzOiBbXG4gICAgLyoqXG4gICAgICogQSBjYWxsIHRvIGxheWVyLk1lbWJlcnNoaXAubG9hZCBoYXMgY29tcGxldGVkIHN1Y2Nlc3NmdWxseVxuICAgICAqXG4gICAgICogQGV2ZW50XG4gICAgICogQHBhcmFtIHtsYXllci5MYXllckV2ZW50fSBldnRcbiAgICAgKiBAcGFyYW0ge2xheWVyLk1lbWJlcnNoaXB9IGV2dC50YXJnZXRcbiAgICAgKi9cbiAgICAnbWVtYmVyczpsb2FkZWQnLFxuXG4gICAgLyoqXG4gICAgICogQW4gSWRlbnRpdHkgaGFzIGhhZCBhIGNoYW5nZSBpbiBpdHMgcHJvcGVydGllcy5cbiAgICAgKlxuICAgICAqIENoYW5nZXMgb2NjdXIgd2hlbiBuZXcgZGF0YSBhcnJpdmVzIGZyb20gdGhlIHNlcnZlci5cbiAgICAgKlxuICAgICAqICAgICAgY2xpZW50Lm9uKCdtZW1iZXJzOmNoYW5nZScsIGZ1bmN0aW9uKGV2dCkge1xuICAgICAqICAgICAgICAgIHZhciBkaXNwbGF5TmFtZUNoYW5nZXMgPSBldnQuZ2V0Q2hhbmdlc0ZvcignZGlzcGxheU5hbWUnKTtcbiAgICAgKiAgICAgICAgICBpZiAoZGlzcGxheU5hbWVDaGFuZ2VzLmxlbmd0aCkge1xuICAgICAqICAgICAgICAgICAgICBteVZpZXcucmVuZGVyU3RhdHVzKGV2dC50YXJnZXQpO1xuICAgICAqICAgICAgICAgIH1cbiAgICAgKiAgICAgIH0pO1xuICAgICAqXG4gICAgICogQGV2ZW50XG4gICAgICogQHBhcmFtIHtsYXllci5MYXllckV2ZW50fSBldnRcbiAgICAgKiBAcGFyYW0ge2xheWVyLk1lbWJlcnNoaXB9IGV2dC50YXJnZXRcbiAgICAgKiBAcGFyYW0ge09iamVjdFtdfSBldnQuY2hhbmdlc1xuICAgICAqIEBwYXJhbSB7TWl4ZWR9IGV2dC5jaGFuZ2VzLm5ld1ZhbHVlXG4gICAgICogQHBhcmFtIHtNaXhlZH0gZXZ0LmNoYW5nZXMub2xkVmFsdWVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZ0LmNoYW5nZXMucHJvcGVydHkgLSBOYW1lIG9mIHRoZSBwcm9wZXJ0eSB0aGF0IGhhcyBjaGFuZ2VkXG4gICAgICovXG4gICAgJ21lbWJlcnM6Y2hhbmdlJyxcblxuICAgIC8qKlxuICAgICAqIEEgbmV3IE1lbWJlciBoYXMgYmVlbiBhZGRlZCB0byB0aGUgQ2xpZW50LlxuICAgICAqXG4gICAgICogVGhpcyBldmVudCBpcyB0cmlnZ2VyZWQgd2hlbmV2ZXIgYSBuZXcgbGF5ZXIuTWVtYmVyc2hpcFxuICAgICAqIGhhcyBiZWVuIHJlY2VpdmVkIGJ5IHRoZSBDbGllbnQuXG4gICAgICpcbiAgICAgICAgICAgIGNsaWVudC5vbignbWVtYmVyczphZGQnLCBmdW5jdGlvbihldnQpIHtcbiAgICAgICAgICAgICAgICBldnQubWVtYmVyc2hpcC5mb3JFYWNoKGZ1bmN0aW9uKG1lbWJlcikge1xuICAgICAgICAgICAgICAgICAgICBteVZpZXcuYWRkTWVtYmVyKG1lbWJlcik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAqXG4gICAgKiBAZXZlbnRcbiAgICAqIEBwYXJhbSB7bGF5ZXIuTGF5ZXJFdmVudH0gZXZ0XG4gICAgKiBAcGFyYW0ge2xheWVyLk1lbWJlcnNoaXBbXX0gZXZ0Lm1lbWJlcnNoaXBcbiAgICAqL1xuICAgICdtZW1iZXJzOmFkZCcsXG5cbiAgICAvKipcbiAgICAgKiBBIE1lbWJlciBoYXMgYmVlbiByZW1vdmVkIGZyb20gdGhlIENsaWVudC5cbiAgICAgKlxuICAgICAqIFRoaXMgZG9lcyBub3QgdHlwaWNhbGx5IG9jY3VyLlxuICAgICAqXG4gICAgICAgICAgICBjbGllbnQub24oJ21lbWJlcnM6cmVtb3ZlJywgZnVuY3Rpb24oZXZ0KSB7XG4gICAgICAgICAgICAgICAgZXZ0Lm1lbWJlcnNoaXAuZm9yRWFjaChmdW5jdGlvbihtZW1iZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgbXlWaWV3LmFkZE1lbWJlcihtZW1iZXIpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgKlxuICAgICogQGV2ZW50XG4gICAgKiBAcGFyYW0ge2xheWVyLkxheWVyRXZlbnR9IGV2dFxuICAgICogQHBhcmFtIHtsYXllci5NZW1iZXJzaGlwW119IGV2dC5tZW1iZXJzaGlwXG4gICAgKi9cbiAgICAnbWVtYmVyczpyZW1vdmUnLFxuICBdLFxuICBsaWZlY3ljbGU6IHtcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7XG4gICAgICB0aGlzLl9tb2RlbHMubWVtYmVycyA9IHt9O1xuICAgIH0sXG4gICAgY2xlYW51cCgpIHtcbiAgICAgIE9iamVjdC5rZXlzKHRoaXMuX21vZGVscy5tZW1iZXJzKS5mb3JFYWNoKChpZCkgPT4ge1xuICAgICAgICBjb25zdCBtZW1iZXIgPSB0aGlzLl9tb2RlbHMubWVtYmVyc1tpZF07XG4gICAgICAgIGlmIChtZW1iZXIgJiYgIW1lbWJlci5pc0Rlc3Ryb3llZCkge1xuICAgICAgICAgIG1lbWJlci5kZXN0cm95KCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgdGhpcy5fbW9kZWxzLm1lbWJlcnMgPSBudWxsO1xuICAgIH0sXG4gICAgcmVzZXQoKSB7XG4gICAgICB0aGlzLl9tb2RlbHMubWVtYmVycyA9IHt9O1xuICAgIH0sXG4gIH0sXG4gIG1ldGhvZHM6IHtcbiAgICAvKipcbiAgICAgKiBSZXRyaWV2ZSB0aGUgbWVtYmVyc2hpcCBpbmZvIGJ5IElELlxuICAgICAqXG4gICAgICogTm90IGZvciB1c2UgaW4gdHlwaWNhbCBhcHBzLlxuICAgICAqXG4gICAgICogQG1ldGhvZCBnZXRNZW1iZXJcbiAgICAgKiBAcGFyYW0gIHtzdHJpbmd9IGlkICAgICAgICAgICAgICAgLSBsYXllcjovLy9jaGFubmVscy91dWlkL21lbWJlcnMvdXNlcl9pZFxuICAgICAqIEBwYXJhbSAge2Jvb2xlYW59IFtjYW5Mb2FkPWZhbHNlXSAtIFBhc3MgdHJ1ZSB0byBhbGxvdyBsb2FkaW5nIGEgbWVtYmVyIGZyb20gdGhlIHNlcnZlciBpZiBub3QgZm91bmRcbiAgICAgKiBAcmV0dXJuIHtsYXllci5NZW1iZXJzaGlwfVxuICAgICAqL1xuICAgIGdldE1lbWJlcihpZCwgY2FuTG9hZCkge1xuICAgICAgaWYgKHR5cGVvZiBpZCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihFcnJvckRpY3Rpb25hcnkuaWRQYXJhbVJlcXVpcmVkKTtcblxuICAgICAgaWYgKHRoaXMuX21vZGVscy5tZW1iZXJzW2lkXSkge1xuICAgICAgICByZXR1cm4gdGhpcy5fbW9kZWxzLm1lbWJlcnNbaWRdO1xuICAgICAgfSBlbHNlIGlmIChjYW5Mb2FkKSB7XG4gICAgICAgIHJldHVybiBTeW5jYWJsZS5sb2FkKGlkLCB0aGlzKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBudWxsO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZXBvcnQgdGhhdCBhIG5ldyBNZW1iZXJzaGlwIGhhcyBiZWVuIGFkZGVkLlxuICAgICAqXG4gICAgICogQG1ldGhvZCBfYWRkTWVtYmVyc2hpcFxuICAgICAqIEBwcm90ZWN0ZWRcbiAgICAgKiBAcGFyYW0gIHtsYXllci5NZW1iZXJzaGlwfSBtZW1iZXJcbiAgICAgKlxuICAgICAqL1xuICAgIF9hZGRNZW1iZXJzaGlwKG1lbWJlcikge1xuICAgICAgaWYgKCF0aGlzLl9tb2RlbHMubWVtYmVyc1ttZW1iZXIuaWRdKSB7XG4gICAgICAgIHRoaXMuX21vZGVscy5tZW1iZXJzW21lbWJlci5pZF0gPSBtZW1iZXI7XG4gICAgICAgIHRoaXMuX3RyaWdnZXJBc3luYygnbWVtYmVyczphZGQnLCB7IG1lbWJlcnM6IFttZW1iZXJdIH0pO1xuICAgICAgICB0aGlzLl9zY2hlZHVsZUNoZWNrQW5kUHVyZ2VDYWNoZShtZW1iZXIpO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZXBvcnQgdGhhdCBhIG1lbWJlciBoYXMgYmVlbiByZW1vdmVkIGZyb20gdGhlIGNsaWVudC5cbiAgICAgKlxuICAgICAqIEBtZXRob2QgX3JlbW92ZU1lbWJlcnNoaXBcbiAgICAgKiBAcHJvdGVjdGVkXG4gICAgICogQHBhcmFtICB7bGF5ZXIuTWVtYmVyc2hpcH0gbWVtYmVyXG4gICAgICovXG4gICAgX3JlbW92ZU1lbWJlcnNoaXAobWVtYmVyKSB7XG4gICAgICBjb25zdCBpZCA9ICh0eXBlb2YgbWVtYmVyID09PSAnc3RyaW5nJykgPyBtZW1iZXIgOiBtZW1iZXIuaWQ7XG4gICAgICBtZW1iZXIgPSB0aGlzLl9tb2RlbHMubWVtYmVyc1tpZF07XG4gICAgICBpZiAobWVtYmVyKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9tb2RlbHMubWVtYmVyc1tpZF07XG4gICAgICAgIGlmICghdGhpcy5faW5DbGVhbnVwKSB7XG4gICAgICAgICAgbWVtYmVyLm9mZihudWxsLCBudWxsLCB0aGlzKTtcbiAgICAgICAgICB0aGlzLl90cmlnZ2VyQXN5bmMoJ21lbWJlcnM6cmVtb3ZlJywgeyBtZW1iZXJzOiBbbWVtYmVyXSB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG4gIH0sXG59O1xuIl19
