'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _get = function get(object, property, receiver) { if (object === null) object = Function.prototype; var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { return get(parent, property, receiver); } } else if ("value" in desc) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } };

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

/**
 * Query class for running a Query on Conversations.
 *
 *
 *      var conversationQuery = client.createQuery({
 *        client: client,
 *        model: layer.Query.Conversation,
 *        sortBy: [{'createdAt': 'desc'}]
 *      });
 *
 *
 * You can change the `paginationWindow` and `sortBy` properties at any time using:
 *
 *      query.update({
 *        paginationWindow: 200
 *      });
 *
 * You can release data held in memory by your queries when done with them:
 *
 *      query.destroy();
 *
 * #### sortBy
 *
 * Note that the `sortBy` property is only supported for Conversations at this time and only
 * supports "createdAt" and "lastMessage.sentAt" as sort fields, and only supports `desc` sort direction.
 *
 *      query.update({
 *        sortBy: [{'lastMessage.sentAt': 'desc'}]
 *      });
 *
 *
 * @class  layer.ConversationsQuery
 * @extends layer.Query
 */
var Root = require('../root');
var Util = require('../client-utils');

var _require = require('../const');

var SYNC_STATE = _require.SYNC_STATE;

var Query = require('./query');

var ConversationsQuery = function (_Query) {
  _inherits(ConversationsQuery, _Query);

  function ConversationsQuery() {
    _classCallCheck(this, ConversationsQuery);

    return _possibleConstructorReturn(this, Object.getPrototypeOf(ConversationsQuery).apply(this, arguments));
  }

  _createClass(ConversationsQuery, [{
    key: '_fetchData',
    value: function _fetchData(pageSize) {
      var _this2 = this;

      var sortBy = this._getSortField();

      this.client.dbManager.loadConversations(sortBy, this._nextDBFromId, pageSize, function (conversations) {
        if (conversations.length) _this2._appendResults({ data: conversations }, true);
      });

      var newRequest = 'conversations?sort_by=' + sortBy + '&page_size=' + pageSize + (this._nextServerFromId ? '&from_id=' + this._nextServerFromId : '');

      if (newRequest !== this._firingRequest) {
        this.isFiring = true;
        this._firingRequest = newRequest;
        this.client.xhr({
          telemetry: {
            name: 'conversation_query_time'
          },
          url: this._firingRequest,
          method: 'GET',
          sync: false
        }, function (results) {
          return _this2._processRunResults(results, newRequest, pageSize);
        });
      }
    }
  }, {
    key: '_getSortField',
    value: function _getSortField() {
      if (this.sortBy && this.sortBy[0] && this.sortBy[0]['lastMessage.sentAt']) {
        return 'last_message';
      } else {
        return 'created_at';
      }
    }
  }, {
    key: '_getItem',
    value: function _getItem(id) {
      switch (Util.typeFromID(id)) {
        case 'messages':
          for (var index = 0; index < this.data.length; index++) {
            var conversation = this.data[index];
            if (conversation.lastMessage && conversation.lastMessage.id === id) return conversation.lastMessage;
          }
          return null;
        case 'conversations':
          return _get(Object.getPrototypeOf(ConversationsQuery.prototype), '_getItem', this).call(this, id);
      }
    }
  }, {
    key: '_appendResultsSplice',
    value: function _appendResultsSplice(item) {
      var data = this.data;
      var index = this._getInsertIndex(item, data);
      data.splice(index, 0, this._getData(item));
    }
  }, {
    key: '_handleEvents',
    value: function _handleEvents(eventName, evt) {
      switch (eventName) {

        // If a Conversation's property has changed, and the Conversation is in this
        // Query's data, then update it.
        case 'conversations:change':
          this._handleChangeEvent('conversations', evt);
          break;

        // If a Conversation is added, and it isn't already in the Query,
        // add it and trigger an event
        case 'conversations:add':
          this._handleAddEvent('conversations', evt);
          break;

        // If a Conversation is deleted, and its still in our data,
        // remove it and trigger an event.
        case 'conversations:remove':
          this._handleRemoveEvent('conversations', evt);
          break;
      }
    }

    // TODO WEB-968: Refactor this into functions for instance, object, sortBy createdAt, sortBy lastMessage

  }, {
    key: '_handleChangeEvent',
    value: function _handleChangeEvent(name, evt) {
      var index = this._getIndex(evt.target.id);

      // If its an ID change (matching Distinct Conversation returned by server) make sure to update our data.
      // If dataType is an instance, its been updated for us.
      if (this.dataType === Query.ObjectDataType) {
        var idChanges = evt.getChangesFor('id');
        if (idChanges.length) {
          index = this._getIndex(idChanges[0].oldValue);
        }
      }

      // If dataType is "object" then update the object and our array;
      // else the object is already updated.
      // Ignore results that aren't already in our data; Results are added via
      // conversations:add events.  Websocket Manager automatically loads anything that receives an event
      // for which we have no object, so we'll get the add event at that time.
      if (index !== -1) {
        var sortField = this._getSortField();
        var reorder = evt.hasProperty('lastMessage') && sortField === 'last_message';
        var newIndex = void 0;

        if (this.dataType === Query.ObjectDataType) {
          if (!reorder) {
            // Replace the changed Conversation with a new immutable object
            this.data = [].concat(_toConsumableArray(this.data.slice(0, index)), [evt.target.toObject()], _toConsumableArray(this.data.slice(index + 1)));
          } else {
            newIndex = this._getInsertIndex(evt.target, this.data);
            this.data.splice(index, 1);
            this.data.splice(newIndex, 0, this._getData(evt.target));
            this.data = this.data.concat([]);
          }
        }

        // Else dataType is instance not object
        else if (reorder) {
            newIndex = this._getInsertIndex(evt.target, this.data);
            if (newIndex !== index) {
              this.data.splice(index, 1);
              this.data.splice(newIndex, 0, evt.target);
            }
          }

        // Trigger a 'property' event
        this._triggerChange({
          type: 'property',
          target: this._getData(evt.target),
          query: this,
          isChange: true,
          changes: evt.changes
        });

        if (reorder && newIndex !== index) {
          this._triggerChange({
            type: 'move',
            target: this._getData(evt.target),
            query: this,
            isChange: false,
            fromIndex: index,
            toIndex: newIndex
          });
        }
      }
    }
  }, {
    key: '_getInsertIndex',
    value: function _getInsertIndex(conversation, data) {
      if (!conversation.isSaved()) return 0;
      var sortField = this._getSortField();
      var index = void 0;
      if (sortField === 'created_at') {
        for (index = 0; index < data.length; index++) {
          var item = data[index];
          if (item.syncState === SYNC_STATE.NEW || item.syncState === SYNC_STATE.SAVING) {
            // No-op do not insert server data before new and unsaved data
          } else if (conversation.createdAt >= item.createdAt) {
            break;
          }
        }
        return index;
      } else {
        var oldIndex = -1;
        var d1 = conversation.lastMessage ? conversation.lastMessage.sentAt : conversation.createdAt;
        for (index = 0; index < data.length; index++) {
          var _item = data[index];
          if (_item.id === conversation.id) {
            oldIndex = index;
          } else if (_item.syncState === SYNC_STATE.NEW || _item.syncState === SYNC_STATE.SAVING) {
            // No-op do not insert server data before new and unsaved data
          } else {
            var d2 = _item.lastMessage ? _item.lastMessage.sentAt : _item.createdAt;
            if (d1 >= d2) break;
          }
        }
        return oldIndex === -1 || oldIndex > index ? index : index - 1;
      }
    }
  }, {
    key: '_handleAddEvent',
    value: function _handleAddEvent(name, evt) {
      var _this3 = this;

      // Filter out any Conversations already in our data
      var list = evt[name].filter(function (conversation) {
        return _this3._getIndex(conversation.id) === -1;
      });

      if (list.length) {
        (function () {
          var data = _this3.data;

          // typically bulk inserts happen via _appendResults(); so this array typically iterates over an array of length 1
          list.forEach(function (conversation) {
            var newIndex = _this3._getInsertIndex(conversation, data);
            data.splice(newIndex, 0, _this3._getData(conversation));

            if (_this3.dataType === Query.ObjectDataType) {
              _this3.data = [].concat(data);
            }
            _this3.totalSize += 1;

            var item = _this3._getData(conversation);
            _this3._triggerChange({
              type: 'insert',
              index: newIndex,
              target: item,
              query: _this3
            });
          });
        })();
      }
    }
  }, {
    key: '_handleRemoveEvent',
    value: function _handleRemoveEvent(name, evt) {
      var _this4 = this;

      var removed = [];
      evt[name].forEach(function (conversation) {
        var index = _this4._getIndex(conversation.id);
        if (index !== -1) {
          if (conversation.id === _this4._nextDBFromId) _this4._nextDBFromId = _this4._updateNextFromId(index);
          if (conversation.id === _this4._nextServerFromId) _this4._nextServerFromId = _this4._updateNextFromId(index);
          removed.push({
            data: conversation,
            index: index
          });
          if (_this4.dataType === Query.ObjectDataType) {
            _this4.data = [].concat(_toConsumableArray(_this4.data.slice(0, index)), _toConsumableArray(_this4.data.slice(index + 1)));
          } else {
            _this4.data.splice(index, 1);
          }
        }
      });

      this.totalSize -= removed.length;
      removed.forEach(function (removedObj) {
        _this4._triggerChange({
          type: 'remove',
          index: removedObj.index,
          target: _this4._getData(removedObj.data),
          query: _this4
        });
      });
    }
  }]);

  return ConversationsQuery;
}(Query);

ConversationsQuery._supportedEvents = [].concat(Query._supportedEvents);

ConversationsQuery.MaxPageSize = 100;

ConversationsQuery.prototype.model = Query.Conversation;

Root.initClass.apply(ConversationsQuery, [ConversationsQuery, 'ConversationsQuery']);

module.exports = ConversationsQuery;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9xdWVyaWVzL2NvbnZlcnNhdGlvbnMtcXVlcnkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWtDQSxJQUFNLE9BQU8sUUFBUSxTQUFSLENBQWI7QUFDQSxJQUFNLE9BQU8sUUFBUSxpQkFBUixDQUFiOztlQUN1QixRQUFRLFVBQVIsQzs7SUFBZixVLFlBQUEsVTs7QUFDUixJQUFNLFFBQVEsUUFBUSxTQUFSLENBQWQ7O0lBRU0sa0I7Ozs7Ozs7Ozs7OytCQUVPLFEsRUFBVTtBQUFBOztBQUNuQixVQUFNLFNBQVMsS0FBSyxhQUFMLEVBQWY7O0FBRUEsV0FBSyxNQUFMLENBQVksU0FBWixDQUFzQixpQkFBdEIsQ0FBd0MsTUFBeEMsRUFBZ0QsS0FBSyxhQUFyRCxFQUFvRSxRQUFwRSxFQUE4RSxVQUFDLGFBQUQsRUFBbUI7QUFDL0YsWUFBSSxjQUFjLE1BQWxCLEVBQTBCLE9BQUssY0FBTCxDQUFvQixFQUFFLE1BQU0sYUFBUixFQUFwQixFQUE2QyxJQUE3QztBQUMzQixPQUZEOztBQUlBLFVBQU0sYUFBYSwyQkFBeUIsTUFBekIsbUJBQTZDLFFBQTdDLElBQ2hCLEtBQUssaUJBQUwsR0FBeUIsY0FBYyxLQUFLLGlCQUE1QyxHQUFnRSxFQURoRCxDQUFuQjs7QUFHQSxVQUFJLGVBQWUsS0FBSyxjQUF4QixFQUF3QztBQUN0QyxhQUFLLFFBQUwsR0FBZ0IsSUFBaEI7QUFDQSxhQUFLLGNBQUwsR0FBc0IsVUFBdEI7QUFDQSxhQUFLLE1BQUwsQ0FBWSxHQUFaLENBQWdCO0FBQ2QscUJBQVc7QUFDVCxrQkFBTTtBQURHLFdBREc7QUFJZCxlQUFLLEtBQUssY0FKSTtBQUtkLGtCQUFRLEtBTE07QUFNZCxnQkFBTTtBQU5RLFNBQWhCLEVBT0c7QUFBQSxpQkFBVyxPQUFLLGtCQUFMLENBQXdCLE9BQXhCLEVBQWlDLFVBQWpDLEVBQTZDLFFBQTdD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QUFNLFlBREs7QUFFWDtBQUZXLFdBQWI7QUFJQSxjQUFJLE9BQUssUUFBTCxLQUFrQixNQUFNLGNBQTVCLEVBQTRDO0FBQzFDLG1CQUFLLElBQUwsZ0NBQWdCLE9BQUssSUFBTCxDQUFVLEtBQVYsQ0FBZ0IsQ0FBaEIsRUFBbUIsS0FBbkIsQ0FBaEIsc0JBQThDLE9BQUssSUFBTCxDQUFVLEtBQVYsQ0FBZ0IsUUFBUSxDQUF4QixDQUE5QztBQUNELFdBRkQsTUFFTztBQUNMLG1CQUFLLElBQUwsQ0FBVSxNQUFWLENBQWlCLEtBQWpCLEVBQXdCLENBQXhCO0FBQ0Q7QUFDRjtBQUNGLE9BZkQ7O0FBaUJBLFdBQUssU0FBTCxJQUFrQixRQUFRLE1BQTFCO0FBQ0EsY0FBUSxPQUFSLENBQWdCLFVBQUMsVUFBRCxFQUFnQjtBQUM5QixlQUFLLGNBQUwsQ0FBb0I7QUFDbEIsZ0JBQU0sUUFEWTtBQUVsQixpQkFBTyxXQUFXLEtBRkE7QUFHbEIsa0JBQVEsT0FBSyxRQUFMLENBQWMsV0FBVyxJQUF6QixDQUhVO0FBSWxCO0FBSmtCLFNBQXBCO0FBTUQsT0FQRDtBQVFEOzs7O0VBN084QixLOztBQWdQakMsbUJBQW1CLGdCQUFuQixHQUFzQyxHQUVwQyxNQUZvQyxDQUU3QixNQUFNLGdCQUZ1QixDQUF0Qzs7QUFLQSxtQkFBbUIsV0FBbkIsR0FBaUMsR0FBakM7O0FBRUEsbUJBQW1CLFNBQW5CLENBQTZCLEtBQTdCLEdBQXFDLE1BQU0sWUFBM0M7O0FBRUEsS0FBSyxTQUFMLENBQWUsS0FBZixDQUFxQixrQkFBckIsRUFBeUMsQ0FBQyxrQkFBRCxFQUFxQixvQkFBckIsQ0FBekM7O0FBRUEsT0FBTyxPQUFQLEdBQWlCLGtCQUFqQiIsImZpbGUiOiJjb252ZXJzYXRpb25zLXF1ZXJ5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBRdWVyeSBjbGFzcyBmb3IgcnVubmluZyBhIFF1ZXJ5IG9uIENvbnZlcnNhdGlvbnMuXG4gKlxuICpcbiAqICAgICAgdmFyIGNvbnZlcnNhdGlvblF1ZXJ5ID0gY2xpZW50LmNyZWF0ZVF1ZXJ5KHtcbiAqICAgICAgICBjbGllbnQ6IGNsaWVudCxcbiAqICAgICAgICBtb2RlbDogbGF5ZXIuUXVlcnkuQ29udmVyc2F0aW9uLFxuICogICAgICAgIHNvcnRCeTogW3snY3JlYXRlZEF0JzogJ2Rlc2MnfV1cbiAqICAgICAgfSk7XG4gKlxuICpcbiAqIFlvdSBjYW4gY2hhbmdlIHRoZSBgcGFnaW5hdGlvbldpbmRvd2AgYW5kIGBzb3J0QnlgIHByb3BlcnRpZXMgYXQgYW55IHRpbWUgdXNpbmc6XG4gKlxuICogICAgICBxdWVyeS51cGRhdGUoe1xuICogICAgICAgIHBhZ2luYXRpb25XaW5kb3c6IDIwMFxuICogICAgICB9KTtcbiAqXG4gKiBZb3UgY2FuIHJlbGVhc2UgZGF0YSBoZWxkIGluIG1lbW9yeSBieSB5b3VyIHF1ZXJpZXMgd2hlbiBkb25lIHdpdGggdGhlbTpcbiAqXG4gKiAgICAgIHF1ZXJ5LmRlc3Ryb3koKTtcbiAqXG4gKiAjIyMjIHNvcnRCeVxuICpcbiAqIE5vdGUgdGhhdCB0aGUgYHNvcnRCeWAgcHJvcGVydHkgaXMgb25seSBzdXBwb3J0ZWQgZm9yIENvbnZlcnNhdGlvbnMgYXQgdGhpcyB0aW1lIGFuZCBvbmx5XG4gKiBzdXBwb3J0cyBcImNyZWF0ZWRBdFwiIGFuZCBcImxhc3RNZXNzYWdlLnNlbnRBdFwiIGFzIHNvcnQgZmllbGRzLCBhbmQgb25seSBzdXBwb3J0cyBgZGVzY2Agc29ydCBkaXJlY3Rpb24uXG4gKlxuICogICAgICBxdWVyeS51cGRhdGUoe1xuICogICAgICAgIHNvcnRCeTogW3snbGFzdE1lc3NhZ2Uuc2VudEF0JzogJ2Rlc2MnfV1cbiAqICAgICAgfSk7XG4gKlxuICpcbiAqIEBjbGFzcyAgbGF5ZXIuQ29udmVyc2F0aW9uc1F1ZXJ5XG4gKiBAZXh0ZW5kcyBsYXllci5RdWVyeVxuICovXG5jb25zdCBSb290ID0gcmVxdWlyZSgnLi4vcm9vdCcpO1xuY29uc3QgVXRpbCA9IHJlcXVpcmUoJy4uL2NsaWVudC11dGlscycpO1xuY29uc3QgeyBTWU5DX1NUQVRFIH0gPSByZXF1aXJlKCcuLi9jb25zdCcpO1xuY29uc3QgUXVlcnkgPSByZXF1aXJlKCcuL3F1ZXJ5Jyk7XG5cbmNsYXNzIENvbnZlcnNhdGlvbnNRdWVyeSBleHRlbmRzIFF1ZXJ5IHtcblxuICBfZmV0Y2hEYXRhKHBhZ2VTaXplKSB7XG4gICAgY29uc3Qgc29ydEJ5ID0gdGhpcy5fZ2V0U29ydEZpZWxkKCk7XG5cbiAgICB0aGlzLmNsaWVudC5kYk1hbmFnZXIubG9hZENvbnZlcnNhdGlvbnMoc29ydEJ5LCB0aGlzLl9uZXh0REJGcm9tSWQsIHBhZ2VTaXplLCAoY29udmVyc2F0aW9ucykgPT4ge1xuICAgICAgaWYgKGNvbnZlcnNhdGlvbnMubGVuZ3RoKSB0aGlzLl9hcHBlbmRSZXN1bHRzKHsgZGF0YTogY29udmVyc2F0aW9ucyB9LCB0cnVlKTtcbiAgICB9KTtcblxuICAgIGNvbnN0IG5ld1JlcXVlc3QgPSBgY29udmVyc2F0aW9ucz9zb3J0X2J5PSR7c29ydEJ5fSZwYWdlX3NpemU9JHtwYWdlU2l6ZX1gICtcbiAgICAgICh0aGlzLl9uZXh0U2VydmVyRnJvbUlkID8gJyZmcm9tX2lkPScgKyB0aGlzLl9uZXh0U2VydmVyRnJvbUlkIDogJycpO1xuXG4gICAgaWYgKG5ld1JlcXVlc3QgIT09IHRoaXMuX2ZpcmluZ1JlcXVlc3QpIHtcbiAgICAgIHRoaXMuaXNGaXJpbmcgPSB0cnVlO1xuICAgICAgdGhpcy5fZmlyaW5nUmVxdWVzdCA9IG5ld1JlcXVlc3Q7XG4gICAgICB0aGlzLmNsaWVudC54aHIoe1xuICAgICAgICB0ZWxlbWV0cnk6IHtcbiAgICAgICAgICBuYW1lOiAnY29udmVyc2F0aW9uX3F1ZXJ5X3RpbWUnLFxuICAgICAgICB9LFxuICAgICAgICB1cmw6IHRoaXMuX2ZpcmluZ1JlcXVlc3QsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHN5bmM6IGZhbHNlLFxuICAgICAgfSwgcmVzdWx0cyA9PiB0aGlzLl9wcm9jZXNzUnVuUmVzdWx0cyhyZXN1bHRzLCBuZXdSZXF1ZXN0LCBwYWdlU2l6ZSkpO1xuICAgIH1cbiAgfVxuXG4gIF9nZXRTb3J0RmllbGQoKSB7XG4gICAgaWYgKHRoaXMuc29ydEJ5ICYmIHRoaXMuc29ydEJ5WzBdICYmIHRoaXMuc29ydEJ5WzBdWydsYXN0TWVzc2FnZS5zZW50QXQnXSkge1xuICAgICAgcmV0dXJuICdsYXN0X21lc3NhZ2UnO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gJ2NyZWF0ZWRfYXQnO1xuICAgIH1cbiAgfVxuXG4gIF9nZXRJdGVtKGlkKSB7XG4gICAgc3dpdGNoIChVdGlsLnR5cGVGcm9tSUQoaWQpKSB7XG4gICAgICBjYXNlICdtZXNzYWdlcyc6XG4gICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0aGlzLmRhdGEubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgICAgY29uc3QgY29udmVyc2F0aW9uID0gdGhpcy5kYXRhW2luZGV4XTtcbiAgICAgICAgICBpZiAoY29udmVyc2F0aW9uLmxhc3RNZXNzYWdlICYmIGNvbnZlcnNhdGlvbi5sYXN0TWVzc2FnZS5pZCA9PT0gaWQpIHJldHVybiBjb252ZXJzYXRpb24ubGFzdE1lc3NhZ2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICBjYXNlICdjb252ZXJzYXRpb25zJzpcbiAgICAgICAgcmV0dXJuIHN1cGVyLl9nZXRJdGVtKGlkKTtcbiAgICB9XG4gIH1cblxuICBfYXBwZW5kUmVzdWx0c1NwbGljZShpdGVtKSB7XG4gICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YTtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuX2dldEluc2VydEluZGV4KGl0ZW0sIGRhdGEpO1xuICAgIGRhdGEuc3BsaWNlKGluZGV4LCAwLCB0aGlzLl9nZXREYXRhKGl0ZW0pKTtcbiAgfVxuXG4gIF9oYW5kbGVFdmVudHMoZXZlbnROYW1lLCBldnQpIHtcbiAgICBzd2l0Y2ggKGV2ZW50TmFtZSkge1xuXG4gICAgICAvLyBJZiBhIENvbnZlcnNhdGlvbidzIHByb3BlcnR5IGhhcyBjaGFuZ2VkLCBhbmQgdGhlIENvbnZlcnNhdGlvbiBpcyBpbiB0aGlzXG4gICAgICAvLyBRdWVyeSdzIGRhdGEsIHRoZW4gdXBkYXRlIGl0LlxuICAgICAgY2FzZSAnY29udmVyc2F0aW9uczpjaGFuZ2UnOlxuICAgICAgICB0aGlzLl9oYW5kbGVDaGFuZ2VFdmVudCgnY29udmVyc2F0aW9ucycsIGV2dCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICAvLyBJZiBhIENvbnZlcnNhdGlvbiBpcyBhZGRlZCwgYW5kIGl0IGlzbid0IGFscmVhZHkgaW4gdGhlIFF1ZXJ5LFxuICAgICAgLy8gYWRkIGl0IGFuZCB0cmlnZ2VyIGFuIGV2ZW50XG4gICAgICBjYXNlICdjb252ZXJzYXRpb25zOmFkZCc6XG4gICAgICAgIHRoaXMuX2hhbmRsZUFkZEV2ZW50KCdjb252ZXJzYXRpb25zJywgZXZ0KTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIC8vIElmIGEgQ29udmVyc2F0aW9uIGlzIGRlbGV0ZWQsIGFuZCBpdHMgc3RpbGwgaW4gb3VyIGRhdGEsXG4gICAgICAvLyByZW1vdmUgaXQgYW5kIHRyaWdnZXIgYW4gZXZlbnQuXG4gICAgICBjYXNlICdjb252ZXJzYXRpb25zOnJlbW92ZSc6XG4gICAgICAgIHRoaXMuX2hhbmRsZVJlbW92ZUV2ZW50KCdjb252ZXJzYXRpb25zJywgZXZ0KTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgLy8gVE9ETyBXRUItOTY4OiBSZWZhY3RvciB0aGlzIGludG8gZnVuY3Rpb25zIGZvciBpbnN0YW5jZSwgb2JqZWN0LCBzb3J0QnkgY3JlYXRlZEF0LCBzb3J0QnkgbGFzdE1lc3NhZ2VcbiAgX2hhbmRsZUNoYW5nZUV2ZW50KG5hbWUsIGV2dCkge1xuICAgIGxldCBpbmRleCA9IHRoaXMuX2dldEluZGV4KGV2dC50YXJnZXQuaWQpO1xuXG4gICAgLy8gSWYgaXRzIGFuIElEIGNoYW5nZSAobWF0Y2hpbmcgRGlzdGluY3QgQ29udmVyc2F0aW9uIHJldHVybmVkIGJ5IHNlcnZlcikgbWFrZSBzdXJlIHRvIHVwZGF0ZSBvdXIgZGF0YS5cbiAgICAvLyBJZiBkYXRhVHlwZSBpcyBhbiBpbnN0YW5jZSwgaXRzIGJlZW4gdXBkYXRlZCBmb3IgdXMuXG4gICAgaWYgKHRoaXMuZGF0YVR5cGUgPT09IFF1ZXJ5Lk9iamVjdERhdGFUeXBlKSB7XG4gICAgICBjb25zdCBpZENoYW5nZXMgPSBldnQuZ2V0Q2hhbmdlc0ZvcignaWQnKTtcbiAgICAgIGlmIChpZENoYW5nZXMubGVuZ3RoKSB7XG4gICAgICAgIGluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoaWRDaGFuZ2VzWzBdLm9sZFZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBJZiBkYXRhVHlwZSBpcyBcIm9iamVjdFwiIHRoZW4gdXBkYXRlIHRoZSBvYmplY3QgYW5kIG91ciBhcnJheTtcbiAgICAvLyBlbHNlIHRoZSBvYmplY3QgaXMgYWxyZWFkeSB1cGRhdGVkLlxuICAgIC8vIElnbm9yZSByZXN1bHRzIHRoYXQgYXJlbid0IGFscmVhZHkgaW4gb3VyIGRhdGE7IFJlc3VsdHMgYXJlIGFkZGVkIHZpYVxuICAgIC8vIGNvbnZlcnNhdGlvbnM6YWRkIGV2ZW50cy4gIFdlYnNvY2tldCBNYW5hZ2VyIGF1dG9tYXRpY2FsbHkgbG9hZHMgYW55dGhpbmcgdGhhdCByZWNlaXZlcyBhbiBldmVudFxuICAgIC8vIGZvciB3aGljaCB3ZSBoYXZlIG5vIG9iamVjdCwgc28gd2UnbGwgZ2V0IHRoZSBhZGQgZXZlbnQgYXQgdGhhdCB0aW1lLlxuICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgIGNvbnN0IHNvcnRGaWVsZCA9IHRoaXMuX2dldFNvcnRGaWVsZCgpO1xuICAgICAgY29uc3QgcmVvcmRlciA9IGV2dC5oYXNQcm9wZXJ0eSgnbGFzdE1lc3NhZ2UnKSAmJiBzb3J0RmllbGQgPT09ICdsYXN0X21lc3NhZ2UnO1xuICAgICAgbGV0IG5ld0luZGV4O1xuXG4gICAgICBpZiAodGhpcy5kYXRhVHlwZSA9PT0gUXVlcnkuT2JqZWN0RGF0YVR5cGUpIHtcbiAgICAgICAgaWYgKCFyZW9yZGVyKSB7XG4gICAgICAgICAgLy8gUmVwbGFjZSB0aGUgY2hhbmdlZCBDb252ZXJzYXRpb24gd2l0aCBhIG5ldyBpbW11dGFibGUgb2JqZWN0XG4gICAgICAgICAgdGhpcy5kYXRhID0gW1xuICAgICAgICAgICAgLi4udGhpcy5kYXRhLnNsaWNlKDAsIGluZGV4KSxcbiAgICAgICAgICAgIGV2dC50YXJnZXQudG9PYmplY3QoKSxcbiAgICAgICAgICAgIC4uLnRoaXMuZGF0YS5zbGljZShpbmRleCArIDEpLFxuICAgICAgICAgIF07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbmV3SW5kZXggPSB0aGlzLl9nZXRJbnNlcnRJbmRleChldnQudGFyZ2V0LCB0aGlzLmRhdGEpO1xuICAgICAgICAgIHRoaXMuZGF0YS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgIHRoaXMuZGF0YS5zcGxpY2UobmV3SW5kZXgsIDAsIHRoaXMuX2dldERhdGEoZXZ0LnRhcmdldCkpO1xuICAgICAgICAgIHRoaXMuZGF0YSA9IHRoaXMuZGF0YS5jb25jYXQoW10pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIEVsc2UgZGF0YVR5cGUgaXMgaW5zdGFuY2Ugbm90IG9iamVjdFxuICAgICAgZWxzZSBpZiAocmVvcmRlcikge1xuICAgICAgICBuZXdJbmRleCA9IHRoaXMuX2dldEluc2VydEluZGV4KGV2dC50YXJnZXQsIHRoaXMuZGF0YSk7XG4gICAgICAgIGlmIChuZXdJbmRleCAhPT0gaW5kZXgpIHtcbiAgICAgICAgICB0aGlzLmRhdGEuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICB0aGlzLmRhdGEuc3BsaWNlKG5ld0luZGV4LCAwLCBldnQudGFyZ2V0KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBUcmlnZ2VyIGEgJ3Byb3BlcnR5JyBldmVudFxuICAgICAgdGhpcy5fdHJpZ2dlckNoYW5nZSh7XG4gICAgICAgIHR5cGU6ICdwcm9wZXJ0eScsXG4gICAgICAgIHRhcmdldDogdGhpcy5fZ2V0RGF0YShldnQudGFyZ2V0KSxcbiAgICAgICAgcXVlcnk6IHRoaXMsXG4gICAgICAgIGlzQ2hhbmdlOiB0cnVlLFxuICAgICAgICBjaGFuZ2VzOiBldnQuY2hhbmdlcyxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAocmVvcmRlciAmJiBuZXdJbmRleCAhPT0gaW5kZXgpIHtcbiAgICAgICAgdGhpcy5fdHJpZ2dlckNoYW5nZSh7XG4gICAgICAgICAgdHlwZTogJ21vdmUnLFxuICAgICAgICAgIHRhcmdldDogdGhpcy5fZ2V0RGF0YShldnQudGFyZ2V0KSxcbiAgICAgICAgICBxdWVyeTogdGhpcyxcbiAgICAgICAgICBpc0NoYW5nZTogZmFsc2UsXG4gICAgICAgICAgZnJvbUluZGV4OiBpbmRleCxcbiAgICAgICAgICB0b0luZGV4OiBuZXdJbmRleCxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgX2dldEluc2VydEluZGV4KGNvbnZlcnNhdGlvbiwgZGF0YSkge1xuICAgIGlmICghY29udmVyc2F0aW9uLmlzU2F2ZWQoKSkgcmV0dXJuIDA7XG4gICAgY29uc3Qgc29ydEZpZWxkID0gdGhpcy5fZ2V0U29ydEZpZWxkKCk7XG4gICAgbGV0IGluZGV4O1xuICAgIGlmIChzb3J0RmllbGQgPT09ICdjcmVhdGVkX2F0Jykge1xuICAgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgZGF0YS5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgICAgY29uc3QgaXRlbSA9IGRhdGFbaW5kZXhdO1xuICAgICAgICBpZiAoaXRlbS5zeW5jU3RhdGUgPT09IFNZTkNfU1RBVEUuTkVXIHx8IGl0ZW0uc3luY1N0YXRlID09PSBTWU5DX1NUQVRFLlNBVklORykge1xuICAgICAgICAgIC8vIE5vLW9wIGRvIG5vdCBpbnNlcnQgc2VydmVyIGRhdGEgYmVmb3JlIG5ldyBhbmQgdW5zYXZlZCBkYXRhXG4gICAgICAgIH0gZWxzZSBpZiAoY29udmVyc2F0aW9uLmNyZWF0ZWRBdCA+PSBpdGVtLmNyZWF0ZWRBdCkge1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gaW5kZXg7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBvbGRJbmRleCA9IC0xO1xuICAgICAgY29uc3QgZDEgPSBjb252ZXJzYXRpb24ubGFzdE1lc3NhZ2UgPyBjb252ZXJzYXRpb24ubGFzdE1lc3NhZ2Uuc2VudEF0IDogY29udmVyc2F0aW9uLmNyZWF0ZWRBdDtcbiAgICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGRhdGEubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIGNvbnN0IGl0ZW0gPSBkYXRhW2luZGV4XTtcbiAgICAgICAgaWYgKGl0ZW0uaWQgPT09IGNvbnZlcnNhdGlvbi5pZCkge1xuICAgICAgICAgIG9sZEluZGV4ID0gaW5kZXg7XG4gICAgICAgIH0gZWxzZSBpZiAoaXRlbS5zeW5jU3RhdGUgPT09IFNZTkNfU1RBVEUuTkVXIHx8IGl0ZW0uc3luY1N0YXRlID09PSBTWU5DX1NUQVRFLlNBVklORykge1xuICAgICAgICAgIC8vIE5vLW9wIGRvIG5vdCBpbnNlcnQgc2VydmVyIGRhdGEgYmVmb3JlIG5ldyBhbmQgdW5zYXZlZCBkYXRhXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgZDIgPSBpdGVtLmxhc3RNZXNzYWdlID8gaXRlbS5sYXN0TWVzc2FnZS5zZW50QXQgOiBpdGVtLmNyZWF0ZWRBdDtcbiAgICAgICAgICBpZiAoZDEgPj0gZDIpIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gb2xkSW5kZXggPT09IC0xIHx8IG9sZEluZGV4ID4gaW5kZXggPyBpbmRleCA6IGluZGV4IC0gMTtcbiAgICB9XG4gIH1cblxuICBfaGFuZGxlQWRkRXZlbnQobmFtZSwgZXZ0KSB7XG4gICAgLy8gRmlsdGVyIG91dCBhbnkgQ29udmVyc2F0aW9ucyBhbHJlYWR5IGluIG91ciBkYXRhXG4gICAgY29uc3QgbGlzdCA9IGV2dFtuYW1lXS5maWx0ZXIoY29udmVyc2F0aW9uID0+IHRoaXMuX2dldEluZGV4KGNvbnZlcnNhdGlvbi5pZCkgPT09IC0xKTtcblxuXG4gICAgaWYgKGxpc3QubGVuZ3RoKSB7XG4gICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhO1xuXG4gICAgICAvLyB0eXBpY2FsbHkgYnVsayBpbnNlcnRzIGhhcHBlbiB2aWEgX2FwcGVuZFJlc3VsdHMoKTsgc28gdGhpcyBhcnJheSB0eXBpY2FsbHkgaXRlcmF0ZXMgb3ZlciBhbiBhcnJheSBvZiBsZW5ndGggMVxuICAgICAgbGlzdC5mb3JFYWNoKChjb252ZXJzYXRpb24pID0+IHtcbiAgICAgICAgY29uc3QgbmV3SW5kZXggPSB0aGlzLl9nZXRJbnNlcnRJbmRleChjb252ZXJzYXRpb24sIGRhdGEpO1xuICAgICAgICBkYXRhLnNwbGljZShuZXdJbmRleCwgMCwgdGhpcy5fZ2V0RGF0YShjb252ZXJzYXRpb24pKTtcblxuXG4gICAgICAgIGlmICh0aGlzLmRhdGFUeXBlID09PSBRdWVyeS5PYmplY3REYXRhVHlwZSkge1xuICAgICAgICAgIHRoaXMuZGF0YSA9IFtdLmNvbmNhdChkYXRhKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnRvdGFsU2l6ZSArPSAxO1xuXG4gICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLl9nZXREYXRhKGNvbnZlcnNhdGlvbik7XG4gICAgICAgIHRoaXMuX3RyaWdnZXJDaGFuZ2Uoe1xuICAgICAgICAgIHR5cGU6ICdpbnNlcnQnLFxuICAgICAgICAgIGluZGV4OiBuZXdJbmRleCxcbiAgICAgICAgICB0YXJnZXQ6IGl0ZW0sXG4gICAgICAgICAgcXVlcnk6IHRoaXMsXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cblxuICBfaGFuZGxlUmVtb3ZlRXZlbnQobmFtZSwgZXZ0KSB7XG4gICAgY29uc3QgcmVtb3ZlZCA9IFtdO1xuICAgIGV2dFtuYW1lXS5mb3JFYWNoKChjb252ZXJzYXRpb24pID0+IHtcbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoY29udmVyc2F0aW9uLmlkKTtcbiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgaWYgKGNvbnZlcnNhdGlvbi5pZCA9PT0gdGhpcy5fbmV4dERCRnJvbUlkKSB0aGlzLl9uZXh0REJGcm9tSWQgPSB0aGlzLl91cGRhdGVOZXh0RnJvbUlkKGluZGV4KTtcbiAgICAgICAgaWYgKGNvbnZlcnNhdGlvbi5pZCA9PT0gdGhpcy5fbmV4dFNlcnZlckZyb21JZCkgdGhpcy5fbmV4dFNlcnZlckZyb21JZCA9IHRoaXMuX3VwZGF0ZU5leHRGcm9tSWQoaW5kZXgpO1xuICAgICAgICByZW1vdmVkLnB1c2goe1xuICAgICAgICAgIGRhdGE6IGNvbnZlcnNhdGlvbixcbiAgICAgICAgICBpbmRleCxcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICh0aGlzLmRhdGFUeXBlID09PSBRdWVyeS5PYmplY3REYXRhVHlwZSkge1xuICAgICAgICAgIHRoaXMuZGF0YSA9IFsuLi50aGlzLmRhdGEuc2xpY2UoMCwgaW5kZXgpLCAuLi50aGlzLmRhdGEuc2xpY2UoaW5kZXggKyAxKV07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5kYXRhLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMudG90YWxTaXplIC09IHJlbW92ZWQubGVuZ3RoO1xuICAgIHJlbW92ZWQuZm9yRWFjaCgocmVtb3ZlZE9iaikgPT4ge1xuICAgICAgdGhpcy5fdHJpZ2dlckNoYW5nZSh7XG4gICAgICAgIHR5cGU6ICdyZW1vdmUnLFxuICAgICAgICBpbmRleDogcmVtb3ZlZE9iai5pbmRleCxcbiAgICAgICAgdGFyZ2V0OiB0aGlzLl9nZXREYXRhKHJlbW92ZWRPYmouZGF0YSksXG4gICAgICAgIHF1ZXJ5OiB0aGlzLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cblxuQ29udmVyc2F0aW9uc1F1ZXJ5Ll9zdXBwb3J0ZWRFdmVudHMgPSBbXG5cbl0uY29uY2F0KFF1ZXJ5Ll9zdXBwb3J0ZWRFdmVudHMpO1xuXG5cbkNvbnZlcnNhdGlvbnNRdWVyeS5NYXhQYWdlU2l6ZSA9IDEwMDtcblxuQ29udmVyc2F0aW9uc1F1ZXJ5LnByb3RvdHlwZS5tb2RlbCA9IFF1ZXJ5LkNvbnZlcnNhdGlvbjtcblxuUm9vdC5pbml0Q2xhc3MuYXBwbHkoQ29udmVyc2F0aW9uc1F1ZXJ5LCBbQ29udmVyc2F0aW9uc1F1ZXJ5LCAnQ29udmVyc2F0aW9uc1F1ZXJ5J10pO1xuXG5tb2R1bGUuZXhwb3J0cyA9IENvbnZlcnNhdGlvbnNRdWVyeTtcbiJdfQ==
