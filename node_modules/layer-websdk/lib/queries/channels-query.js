'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

/**
 * Query class for running a Query on Channels
 *
 *      var channelQuery = client.createQuery({
 *        client: client,
 *        model: layer.Query.Channel
 *      });
 *
 *
 * You can change the `paginationWindow` property at any time using:
 *
 *      query.update({
 *        paginationWindow: 200
 *      });
 *
 * You can release data held in memory by your queries when done with them:
 *
 *      query.destroy();
 *
 * @class  layer.ChannelsQuery
 * @extends layer.Query
 */
var Root = require('../root');

var _require = require('../const');

var SYNC_STATE = _require.SYNC_STATE;

var Query = require('./query');
var ConversationsQuery = require('./conversations-query');

var ChannelsQuery = function (_ConversationsQuery) {
  _inherits(ChannelsQuery, _ConversationsQuery);

  function ChannelsQuery() {
    _classCallCheck(this, ChannelsQuery);

    return _possibleConstructorReturn(this, Object.getPrototypeOf(ChannelsQuery).apply(this, arguments));
  }

  _createClass(ChannelsQuery, [{
    key: '_fetchData',
    value: function _fetchData(pageSize) {
      var _this2 = this;

      this.client.dbManager.loadChannels(this._nextDBFromId, pageSize, function (channels) {
        if (channels.length) _this2._appendResults({ data: channels }, true);
      });

      var newRequest = 'channels?page_size=' + pageSize + (this._nextServerFromId ? '&from_id=' + this._nextServerFromId : '');

      if (newRequest !== this._firingRequest) {
        this.isFiring = true;
        this._firingRequest = newRequest;
        this.client.xhr({
          telemetry: {
            name: 'channel_query_time'
          },
          url: this._firingRequest,
          method: 'GET',
          sync: false
        }, function (results) {
          return _this2._processRunResults(results, _this2._firingRequest, pageSize);
        });
      }
    }
  }, {
    key: '_getSortField',
    value: function _getSortField() {
      return 'created_at';
    }
  }, {
    key: '_getItem',
    value: function _getItem(id) {
      return Query.prototype._getItem.apply(this, [id]);
    }
  }, {
    key: '_handleEvents',
    value: function _handleEvents(eventName, evt) {
      switch (eventName) {

        // If a Conversation's property has changed, and the Conversation is in this
        // Query's data, then update it.
        case 'channels:change':
          this._handleChangeEvent('channels', evt);
          break;

        // If a Conversation is added, and it isn't already in the Query,
        // add it and trigger an event
        case 'channels:add':
          this._handleAddEvent('channels', evt);
          break;

        // If a Conversation is deleted, and its still in our data,
        // remove it and trigger an event.
        case 'channels:remove':
          this._handleRemoveEvent('channels', evt);
          break;
      }
    }
  }, {
    key: '_appendResultsSplice',
    value: function _appendResultsSplice(item) {
      this.data.unshift(this._getData(item));
    }
  }, {
    key: '_handleChangeEvent',
    value: function _handleChangeEvent(name, evt) {
      var index = this._getIndex(evt.target.id);

      // If its an ID change (matching named channel returned by server) make sure to update our data.
      // If dataType is an instance, its been updated for us.
      if (this.dataType === Query.ObjectDataType) {
        var idChanges = evt.getChangesFor('id');
        if (idChanges.length) {
          index = this._getIndex(idChanges[0].oldValue);
        }
      }

      // If dataType is "object" then update the object and our array;
      // else the object is already updated.
      // Ignore results that aren't already in our data; Results are added via
      // channels:add events.  Websocket Manager automatically loads anything that receives an event
      // for which we have no object, so we'll get the add event at that time.
      if (index !== -1) {
        var sortField = this._getSortField();
        var reorder = evt.hasProperty('lastMessage') && sortField === 'last_message';
        var newIndex = void 0;

        if (this.dataType === Query.ObjectDataType) {
          if (!reorder) {
            // Replace the changed Channel with a new immutable object
            this.data = [].concat(_toConsumableArray(this.data.slice(0, index)), [evt.target.toObject()], _toConsumableArray(this.data.slice(index + 1)));
          } else {
            newIndex = this._getInsertIndex(evt.target, this.data);
            this.data.splice(index, 1);
            this.data.splice(newIndex, 0, this._getData(evt.target));
            this.data = this.data.concat([]);
          }
        }

        // Else dataType is instance not object
        else if (reorder) {
            newIndex = this._getInsertIndex(evt.target, this.data);
            if (newIndex !== index) {
              this.data.splice(index, 1);
              this.data.splice(newIndex, 0, evt.target);
            }
          }

        // Trigger a 'property' event
        this._triggerChange({
          type: 'property',
          target: this._getData(evt.target),
          query: this,
          isChange: true,
          changes: evt.changes
        });

        if (reorder && newIndex !== index) {
          this._triggerChange({
            type: 'move',
            target: this._getData(evt.target),
            query: this,
            isChange: false,
            fromIndex: index,
            toIndex: newIndex
          });
        }
      }
    }
  }, {
    key: '_getInsertIndex',
    value: function _getInsertIndex(channel, data) {
      if (!channel.isSaved()) return 0;
      var sortField = this._getSortField();
      var index = void 0;
      if (sortField === 'created_at') {
        for (index = 0; index < data.length; index++) {
          var item = data[index];
          if (item.syncState === SYNC_STATE.NEW || item.syncState === SYNC_STATE.SAVING) {
            // No-op do not insert server data before new and unsaved data
          } else if (channel.createdAt >= item.createdAt) {
            break;
          }
        }
        return index;
      } else {
        var oldIndex = -1;
        var d1 = channel.lastMessage ? channel.lastMessage.sentAt : channel.createdAt;
        for (index = 0; index < data.length; index++) {
          var _item = data[index];
          if (_item.id === channel.id) {
            oldIndex = index;
          } else if (_item.syncState === SYNC_STATE.NEW || _item.syncState === SYNC_STATE.SAVING) {
            // No-op do not insert server data before new and unsaved data
          } else {
            var d2 = _item.lastMessage ? _item.lastMessage.sentAt : _item.createdAt;
            if (d1 >= d2) break;
          }
        }
        return oldIndex === -1 || oldIndex > index ? index : index - 1;
      }
    }
  }, {
    key: '_handleAddEvent',
    value: function _handleAddEvent(name, evt) {
      var _this3 = this;

      // Filter out any Channels already in our data
      var list = evt[name].filter(function (channel) {
        return _this3._getIndex(channel.id) === -1;
      });

      if (list.length) {
        (function () {
          var data = _this3.data;

          // typically bulk inserts happen via _appendResults(); so this array typically iterates over an array of length 1
          list.forEach(function (channel) {
            var newIndex = _this3._getInsertIndex(channel, data);
            data.splice(newIndex, 0, _this3._getData(channel));

            // Typically this loop only iterates once; but each iteration is gaurenteed a unique object if needed
            if (_this3.dataType === Query.ObjectDataType) {
              _this3.data = [].concat(data);
            }
            _this3.totalSize += 1;

            var item = _this3._getData(channel);
            _this3._triggerChange({
              type: 'insert',
              index: newIndex,
              target: item,
              query: _this3
            });
          });
        })();
      }
    }
  }, {
    key: '_handleRemoveEvent',
    value: function _handleRemoveEvent(name, evt) {
      var _this4 = this;

      var removed = [];
      evt[name].forEach(function (channel) {
        var index = _this4._getIndex(channel.id);
        if (index !== -1) {
          if (channel.id === _this4._nextDBFromId) _this4._nextDBFromId = _this4._updateNextFromId(index);
          if (channel.id === _this4._nextServerFromId) _this4._nextServerFromId = _this4._updateNextFromId(index);
          removed.push({
            data: channel,
            index: index
          });
          if (_this4.dataType === Query.ObjectDataType) {
            _this4.data = [].concat(_toConsumableArray(_this4.data.slice(0, index)), _toConsumableArray(_this4.data.slice(index + 1)));
          } else {
            _this4.data.splice(index, 1);
          }
        }
      });

      this.totalSize -= removed.length;
      removed.forEach(function (removedObj) {
        _this4._triggerChange({
          type: 'remove',
          index: removedObj.index,
          target: _this4._getData(removedObj.data),
          query: _this4
        });
      });
    }
  }]);

  return ChannelsQuery;
}(ConversationsQuery);

ChannelsQuery._supportedEvents = [].concat(ConversationsQuery._supportedEvents);

ChannelsQuery.MaxPageSize = 100;

ChannelsQuery.prototype.model = Query.Channel;

Root.initClass.apply(ChannelsQuery, [ChannelsQuery, 'ChannelsQuery']);

module.exports = ChannelsQuery;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9xdWVyaWVzL2NoYW5uZWxzLXF1ZXJ5LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBc0JBLElBQU0sT0FBTyxRQUFRLFNBQVIsQ0FBYjs7ZUFDdUIsUUFBUSxVQUFSLEM7O0lBQWYsVSxZQUFBLFU7O0FBQ1IsSUFBTSxRQUFRLFFBQVEsU0FBUixDQUFkO0FBQ0EsSUFBTSxxQkFBcUIsUUFBUSx1QkFBUixDQUEzQjs7SUFFTSxhOzs7Ozs7Ozs7OzsrQkFFTyxRLEVBQVU7QUFBQTs7QUFDbkIsV0FBSyxNQUFMLENBQVksU0FBWixDQUFzQixZQUF0QixDQUFtQyxLQUFLLGFBQXhDLEVBQXVELFFBQXZELEVBQWlFLFVBQUMsUUFBRCxFQUFjO0FBQzdFLFlBQUksU0FBUyxNQUFiLEVBQXFCLE9BQUssY0FBTCxDQUFvQixFQUFFLE1BQU0sUUFBUixFQUFwQixFQUF3QyxJQUF4QztBQUN0QixPQUZEOztBQUlBLFVBQU0sYUFBYSx3QkFBc0IsUUFBdEIsSUFDaEIsS0FBSyxpQkFBTCxHQUF5QixjQUFjLEtBQUssaUJBQTVDLEdBQWdFLEVBRGhELENBQW5COztBQUdBLFVBQUksZUFBZSxLQUFLLGNBQXhCLEVBQXdDO0FBQ3RDLGFBQUssUUFBTCxHQUFnQixJQUFoQjtBQUNBLGFBQUssY0FBTCxHQUFzQixVQUF0QjtBQUNBLGFBQUssTUFBTCxDQUFZLEdBQVosQ0FBZ0I7QUFDZCxxQkFBVztBQUNULGtCQUFNO0FBREcsV0FERztBQUlkLGVBQUssS0FBSyxjQUpJO0FBS2Qsa0JBQVEsS0FMTTtBQU1kLGdCQUFNO0FBTlEsU0FBaEIsRUFPRztBQUFBLGlCQUFXLE9BQUssa0JBQUwsQ0FBd0IsT0FBeEIsRUFBaUMsT0FBSyxjQUF0QyxFQUFzRCxRQUF0RCxDQUFYO0FBQUEsU0FQSDtBQVFEO0FBQ0Y7OztvQ0FFZTtBQUNkLGFBQU8sWUFBUDtBQUNEOzs7NkJBRVEsRSxFQUFJO0FB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eEIsbUJBQW1CLGdCQUZLLENBQWpDOztBQUtBLGNBQWMsV0FBZCxHQUE0QixHQUE1Qjs7QUFFQSxjQUFjLFNBQWQsQ0FBd0IsS0FBeEIsR0FBZ0MsTUFBTSxPQUF0Qzs7QUFFQSxLQUFLLFNBQUwsQ0FBZSxLQUFmLENBQXFCLGFBQXJCLEVBQW9DLENBQUMsYUFBRCxFQUFnQixlQUFoQixDQUFwQzs7QUFFQSxPQUFPLE9BQVAsR0FBaUIsYUFBakIiLCJmaWxlIjoiY2hhbm5lbHMtcXVlcnkuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFF1ZXJ5IGNsYXNzIGZvciBydW5uaW5nIGEgUXVlcnkgb24gQ2hhbm5lbHNcbiAqXG4gKiAgICAgIHZhciBjaGFubmVsUXVlcnkgPSBjbGllbnQuY3JlYXRlUXVlcnkoe1xuICogICAgICAgIGNsaWVudDogY2xpZW50LFxuICogICAgICAgIG1vZGVsOiBsYXllci5RdWVyeS5DaGFubmVsXG4gKiAgICAgIH0pO1xuICpcbiAqXG4gKiBZb3UgY2FuIGNoYW5nZSB0aGUgYHBhZ2luYXRpb25XaW5kb3dgIHByb3BlcnR5IGF0IGFueSB0aW1lIHVzaW5nOlxuICpcbiAqICAgICAgcXVlcnkudXBkYXRlKHtcbiAqICAgICAgICBwYWdpbmF0aW9uV2luZG93OiAyMDBcbiAqICAgICAgfSk7XG4gKlxuICogWW91IGNhbiByZWxlYXNlIGRhdGEgaGVsZCBpbiBtZW1vcnkgYnkgeW91ciBxdWVyaWVzIHdoZW4gZG9uZSB3aXRoIHRoZW06XG4gKlxuICogICAgICBxdWVyeS5kZXN0cm95KCk7XG4gKlxuICogQGNsYXNzICBsYXllci5DaGFubmVsc1F1ZXJ5XG4gKiBAZXh0ZW5kcyBsYXllci5RdWVyeVxuICovXG5jb25zdCBSb290ID0gcmVxdWlyZSgnLi4vcm9vdCcpO1xuY29uc3QgeyBTWU5DX1NUQVRFIH0gPSByZXF1aXJlKCcuLi9jb25zdCcpO1xuY29uc3QgUXVlcnkgPSByZXF1aXJlKCcuL3F1ZXJ5Jyk7XG5jb25zdCBDb252ZXJzYXRpb25zUXVlcnkgPSByZXF1aXJlKCcuL2NvbnZlcnNhdGlvbnMtcXVlcnknKTtcblxuY2xhc3MgQ2hhbm5lbHNRdWVyeSBleHRlbmRzIENvbnZlcnNhdGlvbnNRdWVyeSB7XG5cbiAgX2ZldGNoRGF0YShwYWdlU2l6ZSkge1xuICAgIHRoaXMuY2xpZW50LmRiTWFuYWdlci5sb2FkQ2hhbm5lbHModGhpcy5fbmV4dERCRnJvbUlkLCBwYWdlU2l6ZSwgKGNoYW5uZWxzKSA9PiB7XG4gICAgICBpZiAoY2hhbm5lbHMubGVuZ3RoKSB0aGlzLl9hcHBlbmRSZXN1bHRzKHsgZGF0YTogY2hhbm5lbHMgfSwgdHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBuZXdSZXF1ZXN0ID0gYGNoYW5uZWxzP3BhZ2Vfc2l6ZT0ke3BhZ2VTaXplfWAgK1xuICAgICAgKHRoaXMuX25leHRTZXJ2ZXJGcm9tSWQgPyAnJmZyb21faWQ9JyArIHRoaXMuX25leHRTZXJ2ZXJGcm9tSWQgOiAnJyk7XG5cbiAgICBpZiAobmV3UmVxdWVzdCAhPT0gdGhpcy5fZmlyaW5nUmVxdWVzdCkge1xuICAgICAgdGhpcy5pc0ZpcmluZyA9IHRydWU7XG4gICAgICB0aGlzLl9maXJpbmdSZXF1ZXN0ID0gbmV3UmVxdWVzdDtcbiAgICAgIHRoaXMuY2xpZW50Lnhocih7XG4gICAgICAgIHRlbGVtZXRyeToge1xuICAgICAgICAgIG5hbWU6ICdjaGFubmVsX3F1ZXJ5X3RpbWUnLFxuICAgICAgICB9LFxuICAgICAgICB1cmw6IHRoaXMuX2ZpcmluZ1JlcXVlc3QsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHN5bmM6IGZhbHNlLFxuICAgICAgfSwgcmVzdWx0cyA9PiB0aGlzLl9wcm9jZXNzUnVuUmVzdWx0cyhyZXN1bHRzLCB0aGlzLl9maXJpbmdSZXF1ZXN0LCBwYWdlU2l6ZSkpO1xuICAgIH1cbiAgfVxuXG4gIF9nZXRTb3J0RmllbGQoKSB7XG4gICAgcmV0dXJuICdjcmVhdGVkX2F0JztcbiAgfVxuXG4gIF9nZXRJdGVtKGlkKSB7XG4gICAgcmV0dXJuIFF1ZXJ5LnByb3RvdHlwZS5fZ2V0SXRlbS5hcHBseSh0aGlzLCBbaWRdKTtcbiAgfVxuXG4gIF9oYW5kbGVFdmVudHMoZXZlbnROYW1lLCBldnQpIHtcbiAgICBzd2l0Y2ggKGV2ZW50TmFtZSkge1xuXG4gICAgICAvLyBJZiBhIENvbnZlcnNhdGlvbidzIHByb3BlcnR5IGhhcyBjaGFuZ2VkLCBhbmQgdGhlIENvbnZlcnNhdGlvbiBpcyBpbiB0aGlzXG4gICAgICAvLyBRdWVyeSdzIGRhdGEsIHRoZW4gdXBkYXRlIGl0LlxuICAgICAgY2FzZSAnY2hhbm5lbHM6Y2hhbmdlJzpcbiAgICAgICAgdGhpcy5faGFuZGxlQ2hhbmdlRXZlbnQoJ2NoYW5uZWxzJywgZXZ0KTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIC8vIElmIGEgQ29udmVyc2F0aW9uIGlzIGFkZGVkLCBhbmQgaXQgaXNuJ3QgYWxyZWFkeSBpbiB0aGUgUXVlcnksXG4gICAgICAvLyBhZGQgaXQgYW5kIHRyaWdnZXIgYW4gZXZlbnRcbiAgICAgIGNhc2UgJ2NoYW5uZWxzOmFkZCc6XG4gICAgICAgIHRoaXMuX2hhbmRsZUFkZEV2ZW50KCdjaGFubmVscycsIGV2dCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICAvLyBJZiBhIENvbnZlcnNhdGlvbiBpcyBkZWxldGVkLCBhbmQgaXRzIHN0aWxsIGluIG91ciBkYXRhLFxuICAgICAgLy8gcmVtb3ZlIGl0IGFuZCB0cmlnZ2VyIGFuIGV2ZW50LlxuICAgICAgY2FzZSAnY2hhbm5lbHM6cmVtb3ZlJzpcbiAgICAgICAgdGhpcy5faGFuZGxlUmVtb3ZlRXZlbnQoJ2NoYW5uZWxzJywgZXZ0KTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cblxuICBfYXBwZW5kUmVzdWx0c1NwbGljZShpdGVtKSB7XG4gICAgdGhpcy5kYXRhLnVuc2hpZnQodGhpcy5fZ2V0RGF0YShpdGVtKSk7XG4gIH1cblxuICBfaGFuZGxlQ2hhbmdlRXZlbnQobmFtZSwgZXZ0KSB7XG4gICAgbGV0IGluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoZXZ0LnRhcmdldC5pZCk7XG5cbiAgICAvLyBJZiBpdHMgYW4gSUQgY2hhbmdlIChtYXRjaGluZyBuYW1lZCBjaGFubmVsIHJldHVybmVkIGJ5IHNlcnZlcikgbWFrZSBzdXJlIHRvIHVwZGF0ZSBvdXIgZGF0YS5cbiAgICAvLyBJZiBkYXRhVHlwZSBpcyBhbiBpbnN0YW5jZSwgaXRzIGJlZW4gdXBkYXRlZCBmb3IgdXMuXG4gICAgaWYgKHRoaXMuZGF0YVR5cGUgPT09IFF1ZXJ5Lk9iamVjdERhdGFUeXBlKSB7XG4gICAgICBjb25zdCBpZENoYW5nZXMgPSBldnQuZ2V0Q2hhbmdlc0ZvcignaWQnKTtcbiAgICAgIGlmIChpZENoYW5nZXMubGVuZ3RoKSB7XG4gICAgICAgIGluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoaWRDaGFuZ2VzWzBdLm9sZFZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBJZiBkYXRhVHlwZSBpcyBcIm9iamVjdFwiIHRoZW4gdXBkYXRlIHRoZSBvYmplY3QgYW5kIG91ciBhcnJheTtcbiAgICAvLyBlbHNlIHRoZSBvYmplY3QgaXMgYWxyZWFkeSB1cGRhdGVkLlxuICAgIC8vIElnbm9yZSByZXN1bHRzIHRoYXQgYXJlbid0IGFscmVhZHkgaW4gb3VyIGRhdGE7IFJlc3VsdHMgYXJlIGFkZGVkIHZpYVxuICAgIC8vIGNoYW5uZWxzOmFkZCBldmVudHMuICBXZWJzb2NrZXQgTWFuYWdlciBhdXRvbWF0aWNhbGx5IGxvYWRzIGFueXRoaW5nIHRoYXQgcmVjZWl2ZXMgYW4gZXZlbnRcbiAgICAvLyBmb3Igd2hpY2ggd2UgaGF2ZSBubyBvYmplY3QsIHNvIHdlJ2xsIGdldCB0aGUgYWRkIGV2ZW50IGF0IHRoYXQgdGltZS5cbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICBjb25zdCBzb3J0RmllbGQgPSB0aGlzLl9nZXRTb3J0RmllbGQoKTtcbiAgICAgIGNvbnN0IHJlb3JkZXIgPSBldnQuaGFzUHJvcGVydHkoJ2xhc3RNZXNzYWdlJykgJiYgc29ydEZpZWxkID09PSAnbGFzdF9tZXNzYWdlJztcbiAgICAgIGxldCBuZXdJbmRleDtcblxuICAgICAgaWYgKHRoaXMuZGF0YVR5cGUgPT09IFF1ZXJ5Lk9iamVjdERhdGFUeXBlKSB7XG4gICAgICAgIGlmICghcmVvcmRlcikge1xuICAgICAgICAgIC8vIFJlcGxhY2UgdGhlIGNoYW5nZWQgQ2hhbm5lbCB3aXRoIGEgbmV3IGltbXV0YWJsZSBvYmplY3RcbiAgICAgICAgICB0aGlzLmRhdGEgPSBbXG4gICAgICAgICAgICAuLi50aGlzLmRhdGEuc2xpY2UoMCwgaW5kZXgpLFxuICAgICAgICAgICAgZXZ0LnRhcmdldC50b09iamVjdCgpLFxuICAgICAgICAgICAgLi4udGhpcy5kYXRhLnNsaWNlKGluZGV4ICsgMSksXG4gICAgICAgICAgXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBuZXdJbmRleCA9IHRoaXMuX2dldEluc2VydEluZGV4KGV2dC50YXJnZXQsIHRoaXMuZGF0YSk7XG4gICAgICAgICAgdGhpcy5kYXRhLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgdGhpcy5kYXRhLnNwbGljZShuZXdJbmRleCwgMCwgdGhpcy5fZ2V0RGF0YShldnQudGFyZ2V0KSk7XG4gICAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5kYXRhLmNvbmNhdChbXSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gRWxzZSBkYXRhVHlwZSBpcyBpbnN0YW5jZSBub3Qgb2JqZWN0XG4gICAgICBlbHNlIGlmIChyZW9yZGVyKSB7XG4gICAgICAgIG5ld0luZGV4ID0gdGhpcy5fZ2V0SW5zZXJ0SW5kZXgoZXZ0LnRhcmdldCwgdGhpcy5kYXRhKTtcbiAgICAgICAgaWYgKG5ld0luZGV4ICE9PSBpbmRleCkge1xuICAgICAgICAgIHRoaXMuZGF0YS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgIHRoaXMuZGF0YS5zcGxpY2UobmV3SW5kZXgsIDAsIGV2dC50YXJnZXQpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFRyaWdnZXIgYSAncHJvcGVydHknIGV2ZW50XG4gICAgICB0aGlzLl90cmlnZ2VyQ2hhbmdlKHtcbiAgICAgICAgdHlwZTogJ3Byb3BlcnR5JyxcbiAgICAgICAgdGFyZ2V0OiB0aGlzLl9nZXREYXRhKGV2dC50YXJnZXQpLFxuICAgICAgICBxdWVyeTogdGhpcyxcbiAgICAgICAgaXNDaGFuZ2U6IHRydWUsXG4gICAgICAgIGNoYW5nZXM6IGV2dC5jaGFuZ2VzLFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChyZW9yZGVyICYmIG5ld0luZGV4ICE9PSBpbmRleCkge1xuICAgICAgICB0aGlzLl90cmlnZ2VyQ2hhbmdlKHtcbiAgICAgICAgICB0eXBlOiAnbW92ZScsXG4gICAgICAgICAgdGFyZ2V0OiB0aGlzLl9nZXREYXRhKGV2dC50YXJnZXQpLFxuICAgICAgICAgIHF1ZXJ5OiB0aGlzLFxuICAgICAgICAgIGlzQ2hhbmdlOiBmYWxzZSxcbiAgICAgICAgICBmcm9tSW5kZXg6IGluZGV4LFxuICAgICAgICAgIHRvSW5kZXg6IG5ld0luZGV4LFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBfZ2V0SW5zZXJ0SW5kZXgoY2hhbm5lbCwgZGF0YSkge1xuICAgIGlmICghY2hhbm5lbC5pc1NhdmVkKCkpIHJldHVybiAwO1xuICAgIGNvbnN0IHNvcnRGaWVsZCA9IHRoaXMuX2dldFNvcnRGaWVsZCgpO1xuICAgIGxldCBpbmRleDtcbiAgICBpZiAoc29ydEZpZWxkID09PSAnY3JlYXRlZF9hdCcpIHtcbiAgICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGRhdGEubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIGNvbnN0IGl0ZW0gPSBkYXRhW2luZGV4XTtcbiAgICAgICAgaWYgKGl0ZW0uc3luY1N0YXRlID09PSBTWU5DX1NUQVRFLk5FVyB8fCBpdGVtLnN5bmNTdGF0ZSA9PT0gU1lOQ19TVEFURS5TQVZJTkcpIHtcbiAgICAgICAgICAvLyBOby1vcCBkbyBub3QgaW5zZXJ0IHNlcnZlciBkYXRhIGJlZm9yZSBuZXcgYW5kIHVuc2F2ZWQgZGF0YVxuICAgICAgICB9IGVsc2UgaWYgKGNoYW5uZWwuY3JlYXRlZEF0ID49IGl0ZW0uY3JlYXRlZEF0KSB7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBpbmRleDtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IG9sZEluZGV4ID0gLTE7XG4gICAgICBjb25zdCBkMSA9IGNoYW5uZWwubGFzdE1lc3NhZ2UgPyBjaGFubmVsLmxhc3RNZXNzYWdlLnNlbnRBdCA6IGNoYW5uZWwuY3JlYXRlZEF0O1xuICAgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgZGF0YS5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgICAgY29uc3QgaXRlbSA9IGRhdGFbaW5kZXhdO1xuICAgICAgICBpZiAoaXRlbS5pZCA9PT0gY2hhbm5lbC5pZCkge1xuICAgICAgICAgIG9sZEluZGV4ID0gaW5kZXg7XG4gICAgICAgIH0gZWxzZSBpZiAoaXRlbS5zeW5jU3RhdGUgPT09IFNZTkNfU1RBVEUuTkVXIHx8IGl0ZW0uc3luY1N0YXRlID09PSBTWU5DX1NUQVRFLlNBVklORykge1xuICAgICAgICAgIC8vIE5vLW9wIGRvIG5vdCBpbnNlcnQgc2VydmVyIGRhdGEgYmVmb3JlIG5ldyBhbmQgdW5zYXZlZCBkYXRhXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgZDIgPSBpdGVtLmxhc3RNZXNzYWdlID8gaXRlbS5sYXN0TWVzc2FnZS5zZW50QXQgOiBpdGVtLmNyZWF0ZWRBdDtcbiAgICAgICAgICBpZiAoZDEgPj0gZDIpIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gb2xkSW5kZXggPT09IC0xIHx8IG9sZEluZGV4ID4gaW5kZXggPyBpbmRleCA6IGluZGV4IC0gMTtcbiAgICB9XG4gIH1cblxuICBfaGFuZGxlQWRkRXZlbnQobmFtZSwgZXZ0KSB7XG4gICAgLy8gRmlsdGVyIG91dCBhbnkgQ2hhbm5lbHMgYWxyZWFkeSBpbiBvdXIgZGF0YVxuICAgIGNvbnN0IGxpc3QgPSBldnRbbmFtZV0uZmlsdGVyKGNoYW5uZWwgPT4gdGhpcy5fZ2V0SW5kZXgoY2hhbm5lbC5pZCkgPT09IC0xKTtcblxuICAgIGlmIChsaXN0Lmxlbmd0aCkge1xuICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YTtcblxuICAgICAgLy8gdHlwaWNhbGx5IGJ1bGsgaW5zZXJ0cyBoYXBwZW4gdmlhIF9hcHBlbmRSZXN1bHRzKCk7IHNvIHRoaXMgYXJyYXkgdHlwaWNhbGx5IGl0ZXJhdGVzIG92ZXIgYW4gYXJyYXkgb2YgbGVuZ3RoIDFcbiAgICAgIGxpc3QuZm9yRWFjaCgoY2hhbm5lbCkgPT4ge1xuICAgICAgICBjb25zdCBuZXdJbmRleCA9IHRoaXMuX2dldEluc2VydEluZGV4KGNoYW5uZWwsIGRhdGEpO1xuICAgICAgICBkYXRhLnNwbGljZShuZXdJbmRleCwgMCwgdGhpcy5fZ2V0RGF0YShjaGFubmVsKSk7XG5cbiAgICAgICAgLy8gVHlwaWNhbGx5IHRoaXMgbG9vcCBvbmx5IGl0ZXJhdGVzIG9uY2U7IGJ1dCBlYWNoIGl0ZXJhdGlvbiBpcyBnYXVyZW50ZWVkIGEgdW5pcXVlIG9iamVjdCBpZiBuZWVkZWRcbiAgICAgICAgaWYgKHRoaXMuZGF0YVR5cGUgPT09IFF1ZXJ5Lk9iamVjdERhdGFUeXBlKSB7XG4gICAgICAgICAgdGhpcy5kYXRhID0gW10uY29uY2F0KGRhdGEpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudG90YWxTaXplICs9IDE7XG5cbiAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMuX2dldERhdGEoY2hhbm5lbCk7XG4gICAgICAgIHRoaXMuX3RyaWdnZXJDaGFuZ2Uoe1xuICAgICAgICAgIHR5cGU6ICdpbnNlcnQnLFxuICAgICAgICAgIGluZGV4OiBuZXdJbmRleCxcbiAgICAgICAgICB0YXJnZXQ6IGl0ZW0sXG4gICAgICAgICAgcXVlcnk6IHRoaXMsXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cblxuICBfaGFuZGxlUmVtb3ZlRXZlbnQobmFtZSwgZXZ0KSB7XG4gICAgY29uc3QgcmVtb3ZlZCA9IFtdO1xuICAgIGV2dFtuYW1lXS5mb3JFYWNoKChjaGFubmVsKSA9PiB7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuX2dldEluZGV4KGNoYW5uZWwuaWQpO1xuICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICBpZiAoY2hhbm5lbC5pZCA9PT0gdGhpcy5fbmV4dERCRnJvbUlkKSB0aGlzLl9uZXh0REJGcm9tSWQgPSB0aGlzLl91cGRhdGVOZXh0RnJvbUlkKGluZGV4KTtcbiAgICAgICAgaWYgKGNoYW5uZWwuaWQgPT09IHRoaXMuX25leHRTZXJ2ZXJGcm9tSWQpIHRoaXMuX25leHRTZXJ2ZXJGcm9tSWQgPSB0aGlzLl91cGRhdGVOZXh0RnJvbUlkKGluZGV4KTtcbiAgICAgICAgcmVtb3ZlZC5wdXNoKHtcbiAgICAgICAgICBkYXRhOiBjaGFubmVsLFxuICAgICAgICAgIGluZGV4LFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKHRoaXMuZGF0YVR5cGUgPT09IFF1ZXJ5Lk9iamVjdERhdGFUeXBlKSB7XG4gICAgICAgICAgdGhpcy5kYXRhID0gWy4uLnRoaXMuZGF0YS5zbGljZSgwLCBpbmRleCksIC4uLnRoaXMuZGF0YS5zbGljZShpbmRleCArIDEpXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmRhdGEuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy50b3RhbFNpemUgLT0gcmVtb3ZlZC5sZW5ndGg7XG4gICAgcmVtb3ZlZC5mb3JFYWNoKChyZW1vdmVkT2JqKSA9PiB7XG4gICAgICB0aGlzLl90cmlnZ2VyQ2hhbmdlKHtcbiAgICAgICAgdHlwZTogJ3JlbW92ZScsXG4gICAgICAgIGluZGV4OiByZW1vdmVkT2JqLmluZGV4LFxuICAgICAgICB0YXJnZXQ6IHRoaXMuX2dldERhdGEocmVtb3ZlZE9iai5kYXRhKSxcbiAgICAgICAgcXVlcnk6IHRoaXMsXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuXG5DaGFubmVsc1F1ZXJ5Ll9zdXBwb3J0ZWRFdmVudHMgPSBbXG5cbl0uY29uY2F0KENvbnZlcnNhdGlvbnNRdWVyeS5fc3VwcG9ydGVkRXZlbnRzKTtcblxuXG5DaGFubmVsc1F1ZXJ5Lk1heFBhZ2VTaXplID0gMTAwO1xuXG5DaGFubmVsc1F1ZXJ5LnByb3RvdHlwZS5tb2RlbCA9IFF1ZXJ5LkNoYW5uZWw7XG5cblJvb3QuaW5pdENsYXNzLmFwcGx5KENoYW5uZWxzUXVlcnksIFtDaGFubmVsc1F1ZXJ5LCAnQ2hhbm5lbHNRdWVyeSddKTtcblxubW9kdWxlLmV4cG9ydHMgPSBDaGFubmVsc1F1ZXJ5O1xuIl19
